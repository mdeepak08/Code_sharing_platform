<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View - Code Sharing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <script src="/js/theme-switcher.js" defer></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">Code Sharing Platform</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" id="project-link" href="#">Project</a> <!-- We'll set this href dynamically -->
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-light me-3" id="userInfo">Loading...</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Project Header -->
        <div class="gh-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 id="projectTitle">Loading project...</h1>
                    <p class="description" id="projectDescription"></p>
                </div>
                <div class="d-flex gap-2">
                    <button class="gh-btn" id="starBtn">
                        <i class="fa fa-star-o"></i> Star
                    </button>
                    <button class="gh-btn" id="forkBtn">
                        <i class="fa fa-code-fork"></i> Fork
                    </button>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="dropdown">
                    <button class="gh-btn dropdown-toggle" id="visibilityToggleBtn" data-bs-toggle="dropdown">
                        <i class="fa fa-lock" id="visibilityBtnIcon"></i>
                        <span id="visibilityBtnText">Private</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="makePublicOption">
                            <i class="fa fa-globe me-2"></i> Make public
                            <div class="small text-muted mt-1">Anyone on the internet can see this repository</div>
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="makePrivateOption">
                            <i class="fa fa-lock me-2"></i> Make private
                            <div class="small text-muted mt-1">You choose who can see and commit to this repository</div>
                        </a></li>
                    </ul>
                </div class="d-flex gap-2">
                <button class="gh-btn" id="starBtn">
                    <i class="fa fa-star-o"></i> Star
                </button>
                <button class="gh-btn" id="forkBtn">
                    <i class="fa fa-code-fork"></i> Fork
                </button>
            </div>
            
            <div class="repo-stats">
                <div class="repo-stat">
                    <i class="fa fa-code-branch"></i>
                    <span id="branchCount">0</span> branches
                </div>
                <div class="repo-stat">
                    <i class="fa fa-tag"></i>
                    <span>0</span> tags
                </div>
                <div class="repo-stat">
                    <i class="fa fa-code"></i>
                    <span id="fileCount">0</span> files
                </div>
                <div class="repo-stat">
                    <i class="fa fa-user"></i>
                    Owner: <span id="projectOwner"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-calendar"></i>
                    Created: <span id="projectCreated"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-eye"></i>
                    <span id="projectVisibility"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb and Branch Selector -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item" id="projectNameBreadcrumb"></li>
                    <li class="breadcrumb-item active" id="currentPath">.</li>
                </ol>
            </nav>
            
            <div class="branch-dropdown">
                <button class="branch-selector dropdown-toggle" id="branchButton">
                    <i class="fa fa-code-branch"></i>
                    <span id="currentBranch">main</span>
                </button>
                <div class="branch-dropdown-content" id="branchDropdown">
                    <div class="branch-search">
                        <input type="text" placeholder="Find a branch..." id="branchSearchInput">
                    </div>
                    <div class="branch-dropdown-header">Branches</div>
                    <div class="branch-list" id="branchList">
                        <!-- Branch items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="filesTab">Files</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="commitsTab">Commits</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="pullRequestsTab">Pull Requests</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="issuesTab">Issues</a>
            </li>
        </ul>
    
        <div class="row">
    
            <div class="col-lg-9"> 
                <div class="file-explorer mb-4">
                    <div class="file-explorer-header">
                        <div class="commit-info">
                            <img src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="User" class="commit-avatar">
                            <span id="lastCommitUser">User</span>
                            committed <span id="lastCommitTime">recently</span>
                        </div>
                        <a href="#" class="text-small text-decoration-none" id="commitsLink">
                            <i class="fa fa-history"></i> History
                        </a>
                    </div>
    
                    <ul class="file-list" id="fileList">
                        <li class="dir-item">
                            <i class="fa fa-folder file-icon file-dir-icon"></i>
                            <a href="#" class="dir-name">Loading...</a>
                        </li>
                    </ul>
                </div>
    
                <div class="code-container mb-4" id="codeContainer" style="display: none;">
                     <div class="code-header">
                        <div class="code-header-filename" id="currentFileName">No file selected</div>
                        <div class="code-header-actions">
                            <a href="#" id="rawButton"><i class="fa fa-file-code"></i> Raw</a>
                            <a href="#" id="downloadButton"><i class="fa fa-download"></i> Download</a>
                            <a href="#" id="copyButton"><i class="fa fa-copy"></i> Copy</a>
                            <a href="#" id="fullScreenButton"><i class="fa fa-expand"></i> Full screen</a>
                        </div>
                    </div>
                    <div class="code-content">
                        <table class="code-blob" id="codeTable">
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
    
                 <div class="commits-container mb-4" id="commitsContainer" style="display: none;">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Commit History</h4>
                        <div class="d-flex align-items-center">
                            <div class="dropdown me-2">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="branchFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-code-branch me-1"></i>
                                    <span id="currentBranchFilter">Current Branch</span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="branchFilterDropdown" id="branchFilterList">
                                    </ul>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="commitFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-filter me-1"></i> Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="commitFilterDropdown">
                                    <li><a class="dropdown-item" href="#" data-filter="all">All Commits</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="my-commits">My Commits</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" data-filter="recent">Last 7 Days</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="month">Last 30 Days</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
    
                    <div id="commitsList" class="commits-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="pull-requests-container mb-4" id="pullRequestsContainer" style="display: none;">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Pull Requests</h4>
                        <button class="btn btn-success" id="newPRButton">
                            <i class="fa fa-plus me-1"></i> New Pull Request
                        </button>
                    </div>
    
                    <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#" data-pr-status="OPEN">Open</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-pr-status="CLOSED">Closed</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" data-pr-status="MERGED">Merged</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body p-0">
                                <div id="pullRequestsList" class="list-group list-group-flush">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
    
            </div><div class="col-lg-3">
                <div class="languages-container mb-4">
                    <h3 class="section-title">Languages</h3>
                    <div class="language-bar-container">
                        <div class="language-bar-loading" id="language-bar-loading"></div>
                        <div class="language-bars" id="language-bars" style="display:none;"></div>
                    </div>
                    <ul class="language-list" id="language-list">
                        </ul>
                </div>
    
    <!-- GitHub-like Modal for Full Screen View -->
    <div class="github-modal" id="fullScreenModal">
        <div class="github-modal-content">
            <div class="github-modal-header">
                <h3 class="github-modal-title" id="modalFileName">File Name</h3>
                <button class="github-modal-close">&times;</button>
            </div>
            <div class="github-modal-body">
                <pre><code id="modalCode"></code></pre>
            </div>
        </div>
    </div>
    <!-- Add this HTML for the commit details modal right before the closing body tag -->
    <div class="modal fade" id="commitDetailsModal" tabindex="-1" aria-labelledby="commitDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="commitDetailsModalLabel">Commit Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <div id="commitDetailsLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <div id="commitDetailsContent" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                <img id="commitAuthorAvatar" src="" alt="Author" class="avatar-img-medium me-2">
                <div>
                    <h5 id="commitMessage" class="mb-1"></h5>
                    <div class="text-muted">
                    <span id="commitAuthor"></span> committed on <span id="commitDate"></span>
                    </div>
                </div>
                </div>
                
                <div class="mb-4">
                <h6>Files Changed</h6>
                <div id="commitFilesList" class="list-group">
                    <!-- Files will be added here -->
                </div>
                </div>
                
                <div id="fileChangesContainer">
                <h6>File Changes</h6>
                <div id="fileChangesContent">
                    <!-- Code diff will be shown here -->
                </div>
                </div>
            </div>
            
            <div id="commitDetailsError" class="alert alert-danger" style="display: none;">
                Error loading commit details.
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<style>


:root {
    --gh-border-color: #e1e4e8;
    --gh-bg-color: #f6f8fa;
    --gh-text-color: #24292e;
    --gh-link-color: #0366d6;
    --gh-secondary-text: #586069;
    --gh-file-line-active: #fffbdd;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    color: var(--gh-text-color);
    line-height: 1.5;
}

.navbar {
    background-color: #24292e;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    padding: 0.5rem 1rem;
}

.gh-header {
    padding: 24px 0;
    border-bottom: 1px solid var(--gh-border-color);
    margin-bottom: 16px;
}

.gh-header h1 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 0;
}

.gh-header .description {
    font-size: 14px;
    color: var(--gh-secondary-text);
    margin-top: 8px;
}

.repo-stats {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
}

.repo-stat {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: var(--gh-secondary-text);
}

.branch-selector {
    background-color: var(--gh-bg-color);
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 14px;
    font-weight: 500;
    color: var(--gh-text-color);
    cursor: pointer;
}

.file-explorer {
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
    overflow: hidden;
}

.file-explorer-header {
    background-color: var(--gh-bg-color);
    padding: 16px;
    border-bottom: 1px solid var(--gh-border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.commit-info {
    display: flex;
    align-items: center;
    font-size: 14px;
    color: var(--gh-secondary-text);
}

.commit-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 4px;
}

.file-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.file-item, .dir-item {
    padding: 8px 16px;
    border-bottom: 1px solid var(--gh-border-color);
    display: flex;
    align-items: center;
}

.file-item:hover, .dir-item:hover {
    background-color: #f8f9fa;
}

.file-item:last-child, .dir-item:last-child {
    border-bottom: none;
}

.file-icon {
    margin-right: 8px;
    color: var(--gh-secondary-text);
}

.file-dir-icon {
    color: #79b8ff;
}

.file-name {
    flex-grow: 1;
    font-size: 14px;
    color: var(--gh-link-color);
    text-decoration: none;
}

.dir-name {
    flex-grow: 1;
    font-size: 14px;
    font-weight: 600;
    color: var(--gh-link-color);
    text-decoration: none;
}

.commit-msg {
    font-size: 12px;
    color: var(--gh-secondary-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 400px; /* Adjust as needed */
    margin-left: auto;
    padding-left: 20px;
}

.code-container {
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
    overflow: hidden;
    /* margin-bottom removed here, added mb-4 in HTML */
}

.code-header {
    padding: 10px 16px;
    background-color: var(--gh-bg-color);
    border-bottom: 1px solid var(--gh-border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-header-filename {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 14px;
    font-weight: 600;
}

.code-header-actions a {
    font-size: 14px;
    color: var(--gh-secondary-text);
    text-decoration: none;
    margin-left: 16px;
}

.code-content {
overflow-x: auto; /* Keep this to allow horizontal scrolling */
background-color: white; /* Consistent background */
font-size: 12px; /* Consistent font size */
}

.code-content pre {
    margin: 0;
    padding: 16px;
    overflow-y: hidden; /* Keep this if you don't want vertical scroll inside pre */
    background-color: white;
}
.github-modal-body pre {
margin: 0;
padding: 16px;
background-color: white;
overflow-x: auto;
}

.github-modal-body code {
font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
font-size: 12px;
line-height: 1.5;
tab-size: 4;
}

.code-content code {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 12px;
    line-height: 1.5;
    tab-size: 4;
}

/* Removed .code-line-numbers as the table structure handles this */

.breadcrumb-item a {
    color: var(--gh-link-color);
    text-decoration: none;
}

.breadcrumb-item.active {
    color: var(--gh-text-color);
}

/* Styles for directory tree (if used elsewhere, keep) */
.directory-structure {
    list-style-type: none;
    padding-left: 0;
}

.directory-structure li {
    padding: 4px 0;
}

.directory-structure ul {
    list-style-type: none;
    padding-left: 20px;
}

.directory-toggle {
    cursor: pointer;
    user-select: none;
}

.directory-toggle::before {
    content: "â–¶";
    display: inline-block;
    width: 12px;
    transition: transform 0.2s;
}

.directory-toggle.open::before {
    transform: rotate(90deg);
}

.file-content {
    display: none; /* If used elsewhere */
}

/* GitHub-like UI elements */
.gh-btn {
    display: inline-flex;
    align-items: center;
    background-color: var(--gh-bg-color);
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
    padding: 5px 12px;
    font-size: 14px;
    font-weight: 500;
    color: var(--gh-text-color);
    cursor: pointer;
    text-decoration: none;
    line-height: 20px;
}

.gh-btn:hover {
    background-color: #f3f4f6;
    text-decoration: none;
}

.gh-btn i {
    margin-right: 4px;
}

.gh-btn-primary {
    background-color: #2ea44f;
    border-color: rgba(27,31,35,0.15);
    color: white;
}

.gh-btn-primary:hover {
    background-color: #2c974b;
    color: white;
}

/* Branch dropdown */
.branch-dropdown {
    position: relative;
    display: inline-block;
}

.branch-dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    width: 300px;
    background-color: white;
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(149,157,165,0.2);
    margin-top: 4px;
}

.branch-dropdown-header {
    padding: 8px 16px;
    border-bottom: 1px solid var(--gh-border-color);
    font-size: 12px;
    font-weight: 600;
}

.branch-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 8px 0;
}

.branch-item {
    padding: 8px 16px;
    display: flex;
    align-items: center;
    cursor: pointer;
}

.branch-item:hover {
    background-color: var(--gh-bg-color);
}

.branch-item.active {
    background-color: #0366d611;
}

.branch-item i {
    margin-right: 8px;
    color: var(--gh-secondary-text);
}

.branch-name {
    flex-grow: 1;
    font-size: 14px;
}

.dropdown-toggle::after {
    display: inline-block;
    margin-left: 6px;
    vertical-align: middle;
    content: "";
    border-top: 4px solid;
    border-right: 4px solid transparent;
    border-bottom: 0;
    border-left: 4px solid transparent;
}

.branch-search {
    padding: 8px 16px;
    border-bottom: 1px solid var(--gh-border-color);
}

.branch-search input {
    width: 100%;
    padding: 5px 12px;
    font-size: 14px;
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
}

/* GitHub code blob table */
.code-blob {
width: 100%;
border-spacing: 0;
border-collapse: collapse; /* Ensure cells are tightly packed */
tab-size: 4; /* Proper tab size */
}

.code-blob tr:hover {
    background-color: var(--gh-bg-color);
}

.code-blob .line-number {
    width: 1%;
    min-width: 50px;
    padding-right: 10px;
    padding-left: 10px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 12px;
    line-height: 20px;
    color: var(--gh-secondary-text);
    text-align: right;
    white-space: nowrap;
    vertical-align: top;
    cursor: pointer;
    user-select: none;
    border-right: 1px solid var(--gh-border-color); /* Added border */
}

.code-blob .line-content {
padding-left: 10px;
padding-right: 10px;
font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
font-size: 12px;
line-height: 20px;
white-space: pre; /* This is crucial - keeps spaces intact */
vertical-align: top;
width: 99%; /* Ensure content takes remaining space */
overflow-x: visible; /* Allow overflow to be visible */
}

/* Utility classes */
.text-small {
    font-size: 12px !important;
}

.text-gray {
    color: var(--gh-secondary-text) !important;
}

/* d-flex and align-items-center are Bootstrap classes, no need to redefine */

/* Modal */
.github-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
}

.github-modal-content {
    position: relative;
    margin: 5% auto;
    width: 80%;
    max-width: 900px;
    background-color: #fff;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(149,157,165,0.2);
}

.github-modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--gh-border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.github-modal-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

.github-modal-close {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.github-modal-body {
    padding: 16px;
    max-height: 70vh;
    overflow-y: auto;
}

#currentPath a {
    color: var(--gh-link-color);
    text-decoration: none;
}

#currentPath a:hover {
    text-decoration: underline;
}

#currentPath span {
    color: var(--gh-text-color);
}

/* Commit item styles */
.commit-item {
    transition: all 0.2s ease;
}

.commit-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.commit-header {
    border-radius: 6px;
    /* background-color: var(--gh-bg); /* Use gh-bg-color */
    background-color: var(--gh-bg-color);
    /* border: 1px solid var(--gh-border); /* Use gh-border-color */
    border: 1px solid var(--gh-border-color);
}

.commit-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--gh-text-color);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    /* max-width: 80%; /* Let flexbox handle width */
}

.commit-meta {
    font-size: 13px;
    /* color: var(--gh-gray); /* Use gh-secondary-text */
    color: var(--gh-secondary-text);
}

.view-details-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Commits container styles */
#commitsList {
    /* padding: 16px; /* Padding handled by container */
    background-color: #fff;
    border-radius: 0 0 6px 6px; /* Keep if needed */
}

/* Commit details section (for future expansion) */
.commit-details {
    margin-top: 16px;
    padding: 16px;
    background-color: #fff;
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
}

.commit-file-changes {
    margin-top: 16px;
}

.file-change-item {
    padding: 8px 12px;
    border: 1px solid var(--gh-border-color);
    border-radius: 4px;
    margin-bottom: 8px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 13px;
}

.file-change-added {
    background-color: #e6ffec;
    border-color: #b4e2c0;
}

.file-change-modified {
    background-color: #f1f8ff;
    border-color: #c8e1ff;
}

.file-change-deleted {
    background-color: #ffebe9;
    border-color: #e9aeaa;
}

/* Language Stats Styles (Now Global) */
.languages-container {
    /* margin-top: 24px; /* Removed, spacing handled by column */
    /* margin-bottom: 24px; /* Removed, spacing handled by column */
    padding: 16px;
    background-color: white;
    border: 1px solid var(--gh-border-color);
    border-radius: 6px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--gh-text-color);
}

.language-bar-container {
    width: 100%;
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 16px;
}

.language-bars {
    display: flex;
    height: 100%;
    width: 100%;
}

.language-bar {
    height: 100%;
    transition: width 0.3s ease;
}

.language-bar-loading {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #eee, #f5f5f5, #eee);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 5px; /* Added */
}

.language-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 16px; /* Consistent gap */
}

.language-item {
    display: flex;
    align-items: center;
    font-size: 12px;
    /* margin-right: 16px; /* Replaced by gap */
}

.language-color {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}

.language-name {
    font-weight: 600;
    margin-right: 4px;
}

.language-percentage {
    color: var(--gh-secondary-text);
}

/* Styles previously inside @media (min-width: 992px) for languages */
.languages-section { /* This class might not be used anymore, but keeping styles */
    background-color: #0d1117; /* Example dark theme color */
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
    color: #c9d1d9;
}

.languages-section h4 {
    font-size: 16px;
    margin-bottom: 10px;
    font-weight: 600;
}

/* Language bar container (duplicate, check which one is used) */
/* .language-bar-container { ... } */

/* Individual language bars */
.lang-bar { /* This class might not be used anymore */
    height: 100%;
    display: inline-block;
}

/* Language list styling (duplicate, check which one is used) */
/* .language-list { ... } */

.lang-item { /* This class might not be used anymore */
    display: flex;
    align-items: center;
    font-size: 12px;
}

/* Colored dot for each language */
.lang-color { /* This class might not be used anymore */
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}

.lang-name { /* This class might not be used anymore */
    margin-right: 5px;
}

.lang-percent { /* This class might not be used anymore */
    color: #8b949e;
}

.loading-placeholder { /* This class might not be used anymore */
    height: 8px;
    width: 100%;
    background: linear-gradient(90deg, #1f2937, #374151, #1f2937);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

/* Keyframes for loading animation */
@keyframes loading {
    0% { background-position: 200% 0 }
    100% { background-position: -200% 0 }
}

/* Toast Notifications */
#toast-container {
    z-index: 1050; /* Ensure it's above other elements */
    position: fixed; /* Keep fixed positioning */
    bottom: 1rem;   /* Adjust positioning */
    right: 1rem;    /* Adjust positioning */
}

.toast {
    min-width: 250px;
    margin-bottom: 10px;
    /* Bootstrap handles base styling */
}

.toast-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724; /* Text color for body */
}

.toast-success .toast-header {
    background-color: #c3e6cb;
    color: #155724;
    border-bottom: 1px solid #b1dfbb; /* Optional header border */
}
 .toast-success .btn-close {
    filter: invert(40%) sepia(50%) saturate(600%) hue-rotate(80deg); /* Greenish close button */
}

.toast-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24; /* Text color for body */
}

.toast-error .toast-header {
    background-color: #f5c6cb;
    color: #721c24;
    border-bottom: 1px solid #f1b0b7; /* Optional header border */
}
 .toast-error .btn-close {
    filter: invert(25%) sepia(30%) saturate(1000%) hue-rotate(320deg); /* Reddish close button */
}

/* Mobile Responsiveness Adjustments */
@media (max-width: 991.98px) { /* Below Bootstrap lg breakpoint */
    .languages-container {
        margin-top: 1.5rem; /* Add some space when stacked */
    }
}

@media (max-width: 767.98px) { /* Below Bootstrap md breakpoint */
    .commit-msg {
        display: none; /* Hide commit message on smaller screens */
    }
    
    .code-header-actions {
        display: none; /* Hide code actions on smaller screens */
    }
    
    .repo-stats {
         gap: 10px; /* Reduce gap */
         justify-content: start; /* Align stats to start */
    }
    .gh-header .d-flex.gap-2 { /* Target Star/Fork buttons container */
        width: 100%;
        margin-top: 1rem;
        justify-content: start;
    }
     .gh-header > .d-flex.gap-2.align-items-center { /* Target Visibility/Star/Fork container */
         width: 100%;
         margin-top: 1rem;
         justify-content: start;
     }
}

</style>
<script>
function hashString(str) {
    let hash = 0;
    if (!str) return '0'; // Handle null or empty strings
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(16);
}

// Also need to add the escapeHtml function that's used in displayCommits
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        return ''; // Return empty string if input is not a string
    }
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Check authentication
const token = localStorage.getItem('jwt_token');
if (!token) {
    window.location.href = '/login.html';
}

// --- Global variables ---
let currentProject = null;
let projectFiles = [];
let projectBranches = [];
let currentBranch = 'main'; // Default branch name
let currentPath = '';

// --- DOM Elements (Define them globally for easier access) ---
const branchButton = document.getElementById('branchButton');
const branchDropdown = document.getElementById('branchDropdown');
const branchList = document.getElementById('branchList');
const branchSearchInput = document.getElementById('branchSearchInput');
const fullScreenModal = document.getElementById('fullScreenModal');
const modalClose = document.querySelector('.github-modal-close');
const filesTab = document.getElementById('filesTab');
const commitsTab = document.getElementById('commitsTab');
const pullRequestsTab = document.getElementById('pullRequestsTab');
const issuesTab = document.getElementById('issuesTab');
const fileExplorerContainer = document.querySelector('.file-explorer'); // Use querySelector if no ID
const codeContainer = document.getElementById('codeContainer');
const commitsContainer = document.getElementById('commitsContainer');
const pullRequestsContainer = document.getElementById('pullRequestsContainer');
// Add other containers if needed (e.g., issuesContainer)

// Get project ID from URL
const urlParams = new URLSearchParams(window.location.search);
const projectId = urlParams.get('id');

if (!projectId) {
    alert('Project ID is missing');
    window.location.href = '/dashboard.html';
}

// --- Functions ---
function logout() {
    localStorage.removeItem('jwt_token');
    window.location.href = '/login.html';
}

// Initialize function - called after DOM is loaded
async function initialize() {
    console.log("Initializing project page...");
    await loadUserInfo();
    await loadProjectDetails(); // Loads project info, sets visibility button state
    await loadProjectBranches(); // Loads branches, sets currentBranch, populates dropdown
    await loadProjectFiles(); // Loads files for the current branch
    loadLanguageStats(); // Loads language stats
    setupEventListeners(); // Sets up ALL event listeners
    updateStarButton(); // Sets initial star button state
    console.log("Initialization complete.");
}

// Load user info
async function loadUserInfo() {
    try {
        const response = await fetch('/api/auth/user', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                document.getElementById('userInfo').textContent = `Welcome, ${escapeHtml(result.data.username)}`;
            } else { document.getElementById('userInfo').textContent = 'Welcome'; }
        } else {
            console.error('Failed to load user info, status:', response.status);
            document.getElementById('userInfo').textContent = 'Welcome';
        }
    } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('userInfo').textContent = 'Welcome';
    }
}

// Load project details
async function loadProjectDetails() {
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                currentProject = result.data;
                document.title = `${escapeHtml(currentProject.name)} - Code Sharing Platform`;
                document.getElementById('projectTitle').textContent = escapeHtml(currentProject.name);
                document.getElementById('projectNameBreadcrumb').innerHTML = `<a href="#project" onclick="navigateToPath('')">${escapeHtml(currentProject.name)}</a>`; // Make project name clickable to go to root
                document.getElementById('projectDescription').textContent = escapeHtml(currentProject.description || 'No description provided');
                document.getElementById('projectOwner').textContent = escapeHtml(currentProject.owner?.username || 'N/A'); // Optional chaining
                document.getElementById('projectCreated').textContent = new Date(currentProject.createdAt).toLocaleDateString();

                const isPublic = currentProject.isPublic !== undefined ? currentProject.isPublic : (currentProject.public !== undefined ? currentProject.public : false); // Handle potential naming difference
                document.getElementById('projectVisibility').textContent = isPublic ? 'Public' : 'Private';
                updateVisibilityDisplay(isPublic); // Update button based on loaded state
            } else {
                throw new Error(result.message || 'Failed to parse project details');
            }
        } else {
            throw new Error(`HTTP error ${response.status} loading project details`);
        }
    } catch (error) {
        console.error('Error loading project details:', error);
        alert(`Failed to load project details: ${error.message}`);
        // Maybe redirect or show a more permanent error message
        // window.location.href = '/dashboard.html';
    }
}

async function loadProjectFiles() {
    // Ensure currentBranch is set
    if (!currentBranch) {
        console.warn("loadProjectFiles called before currentBranch is set. Waiting for branches...");
        return;
    }
    
    console.log(`Loading files for branch: ${currentBranch}`);
    const fileListElement = document.getElementById('fileList');
    fileListElement.innerHTML = '<li class="dir-item"><span class="text-muted">Loading files...</span></li>';

    try {
        // Find the branch ID by name
        const branch = projectBranches.find(b => b.name === currentBranch);
        if (!branch || !branch.id) {
            console.warn(`Could not find branch ID for branch: ${currentBranch}`);
            throw new Error(`Branch ID not found for: ${currentBranch}`);
        }
        
        // Use the branch-specific endpoint
        const response = await fetch(`/api/files/project/${projectId}/branch/${branch.id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success && Array.isArray(result.data)) {
                projectFiles = result.data;
                document.getElementById('fileCount').textContent = projectFiles.length;
                displayFiles(buildFileTree(projectFiles));
            } else {
                console.warn("No files data received or invalid format:", result);
                fileListElement.innerHTML = `<li class="file-item">
                    <span class="text-muted">No files found in branch '${escapeHtml(currentBranch)}'.</span>
                </li>`;
                document.getElementById('fileCount').textContent = 0;
            }
        } else {
            // If we get a 404 it might mean the endpoint isn't implemented yet
            if (response.status === 404 || response.status === 403) {
                console.warn("Branch-specific endpoint not available, falling back to project files");
                // Fallback to regular project files endpoint
                const fallbackResponse = await fetch(`/api/files/project/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (fallbackResponse.ok) {
                    const fallbackResult = await fallbackResponse.json();
                    if (fallbackResult.success && Array.isArray(fallbackResult.data)) {
                        projectFiles = fallbackResult.data;
                        document.getElementById('fileCount').textContent = projectFiles.length;
                        displayFiles(buildFileTree(projectFiles));
                        // Display a notice about fallback behavior
                        showToast(`Branch-specific files not available. Showing all project files.`, 'warning');
                    } else {
                        throw new Error("Failed to load files with fallback method");
                    }
                } else {
                    throw new Error(`HTTP error ${fallbackResponse.status} in fallback`);
                }
            } else {
                throw new Error(`HTTP error ${response.status} loading files`);
            }
        }
    } catch (error) {
        console.error('Error loading files:', error);
        fileListElement.innerHTML = `<li class="file-item">
            <div class="alert alert-danger p-2">Failed to load files: ${error.message}</div>
        </li>`;
        document.getElementById('fileCount').textContent = 0;
    }
}

// Load All Branches
async function loadProjectBranches() {
    try {
        console.log("Loading project branches...");
        const response = await fetch(`/api/branches/project/${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const result = await response.json();
            console.log("Branches API response:", result);

            if (result.success && Array.isArray(result.data)) {
                projectBranches = result.data;
                document.getElementById('branchCount').textContent = projectBranches.length;

                const defaultBranch = projectBranches.find(branch => branch.default);
                if (defaultBranch) {
                    currentBranch = defaultBranch.name;
                    console.log("Default branch found:", currentBranch);
                } else if (projectBranches.length > 0) {
                    currentBranch = projectBranches[0].name; // Fallback to first branch
                    console.log("No default branch, using first branch:", currentBranch);
                } else {
                    currentBranch = "main"; // Fallback if no branches exist at all
                    console.log("No branches found, defaulting to 'main'");
                    document.getElementById('branchCount').textContent = "0";
                }
                document.getElementById('currentBranch').textContent = escapeHtml(currentBranch);
                populateBranchDropdown(); // Populate dropdown AFTER branches are loaded
                // Now that branches are loaded and currentBranch is set, load files
                await loadProjectFiles(); // Load files for the determined branch
            } else {
                console.log("No branches returned from API or invalid format.");
                projectBranches = []; // Ensure it's an empty array
                currentBranch = "main"; // Default branch name
                document.getElementById('currentBranch').textContent = currentBranch;
                document.getElementById('branchCount').textContent = "0";
                populateBranchDropdown(); // Populate with empty state if needed
                await loadProjectFiles(); // Attempt to load files for default branch
            }
        } else {
             throw new Error(`HTTP error ${response.status} loading branches`);
        }
    } catch (error) {
        console.error('Error loading branches:', error);
        // Display error or default state
        projectBranches = [];
        currentBranch = "main";
        document.getElementById('currentBranch').textContent = currentBranch;
        document.getElementById('branchCount').textContent = "0";
        populateBranchDropdown(); // Show empty dropdown state
         // Optionally try loading files for 'main' even if branch loading failed
         await loadProjectFiles();
    }
}

// Populate branch dropdown
function populateBranchDropdown() {
    branchList.innerHTML = ''; // Clear previous items

    if (projectBranches.length === 0) {
         branchList.innerHTML = '<div class="p-2 text-muted text-small">No branches found.</div>';
         return;
    }

    projectBranches.forEach(branch => {
        const branchItem = document.createElement('div');
        branchItem.className = `branch-item d-flex justify-content-between align-items-center ${branch.name === currentBranch ? 'active' : ''}`;
        branchItem.dataset.branch = branch.name; // Store branch name

        branchItem.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fa fa-code-branch me-2"></i>
                <span class="branch-name">${escapeHtml(branch.name)}</span>
            </div>
            ${branch.default ? '<span class="badge bg-success text-small ms-auto">default</span>' : ''}
        `;

        branchItem.addEventListener('click', async function() { // Make async
            const selectedBranch = this.dataset.branch;
            if (selectedBranch !== currentBranch) {
                 console.log(`Switching to branch: ${selectedBranch}`);
                 currentBranch = selectedBranch;
                 document.getElementById('currentBranch').textContent = escapeHtml(currentBranch);
                 // Update active item in dropdown
                 document.querySelectorAll('#branchList .branch-item').forEach(item => item.classList.remove('active'));
                 this.classList.add('active');
                 // Reset path and reload files for the new branch
                 currentPath = ''; // Go back to root when switching branches
                 updateBreadcrumbPath(currentPath);
                 document.getElementById('codeContainer').style.display = 'none'; // Hide code view
                 await loadProjectFiles(); // Await file loading
            }
            branchDropdown.style.display = 'none'; // Close dropdown
        });

        branchList.appendChild(branchItem);
    });
}


// Build file tree from flat list of files for the *current branch*
function buildFileTree(files) {
    const root = { type: 'dir', name: '', path: '', children: {} };

    files.forEach(file => {
        // Normalize path: remove leading/trailing slashes and split
        let path = file.path.replace(/^\/+|\/+$/g, ''); // Remove leading/trailing slashes
        let parts = path.split('/');

        let currentDir = root;
        let currentPathAccumulator = ''; // Accumulate path for dirs

        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!part) continue; // Skip empty parts (e.g., double slashes)

            currentPathAccumulator = currentPathAccumulator ? `${currentPathAccumulator}/${part}` : part;

            if (!currentDir.children[part]) {
                currentDir.children[part] = {
                    type: 'dir',
                    name: part,
                    path: currentPathAccumulator, // Store the full path to this dir
                    children: {}
                };
            }
            currentDir = currentDir.children[part];
        }

        const fileName = parts[parts.length - 1];
        if (fileName) { // Ensure it's not just a directory path
            currentDir.children[fileName] = {
                type: 'file',
                name: fileName,
                path: file.path, // Store original full path from API
                id: file.id, // Assuming file object has an ID
                // content: file.content // Avoid storing content here unless small/necessary
            };
        }
    });
    return root;
}


// Display files based on the *currentPath* within the *projectFiles* tree
function displayFiles(root) {
    const fileListElement = document.getElementById('fileList');
    fileListElement.innerHTML = ''; // Clear previous list

    // --- Navigate to the correct directory within the tree based on currentPath ---
    let currentDir = root;
    if (currentPath) {
        const pathParts = currentPath.split('/');
        for (const part of pathParts) {
            if (part && currentDir.children && currentDir.children[part] && currentDir.children[part].type === 'dir') {
                currentDir = currentDir.children[part];
            } else if (part) {
                console.error(`Path part "${part}" not found or not a directory in current tree structure.`);
                fileListElement.innerHTML = '<li class="file-item"><div class="alert alert-warning">Error navigating path.</div></li>';
                return; // Stop rendering if path is invalid
            }
        }
    }
    // --- ---

    // Add parent directory link ('..') if not at the root
    if (currentPath !== '') {
        const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
        const parentItem = document.createElement('li');
        parentItem.className = 'dir-item';
        parentItem.innerHTML = `
            <i class="fa fa-level-up-alt file-icon text-secondary me-2"></i>
            <a href="#.." class="dir-name" data-path="${parentPath}">..</a>
        `;
        parentItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(this.dataset.path);
        });
        fileListElement.appendChild(parentItem);
    }

    // Get directory and file entries for the current level
    const entries = Object.values(currentDir.children || {});
    const dirEntries = entries.filter(entry => entry.type === 'dir').sort((a, b) => a.name.localeCompare(b.name));
    const fileEntries = entries.filter(entry => entry.type === 'file').sort((a, b) => a.name.localeCompare(b.name));

    // Display Directories
    dirEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'dir-item';
        listItem.innerHTML = `
            <i class="fa fa-folder file-icon file-dir-icon me-2"></i>
            <a href="#${entry.path}" class="dir-name" data-path="${entry.path}">${escapeHtml(entry.name)}</a>
            <span class="commit-msg text-muted ms-auto"></span> `;
        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(this.dataset.path);
        });
        fileListElement.appendChild(listItem);
    });

    // Display Files
    fileEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'file-item';

        // Determine file icon
        let fileIconClass = 'fa-file'; // Define fileIconClass here
        const ext = entry.name.split('.').pop().toLowerCase();
        
        if (['java', 'js', 'ts', 'py', 'rb', 'php', 'c', 'cpp', 'h', 'cs'].includes(ext)) {
            fileIconClass = 'fa-file-code';
        } else if (['md', 'txt', 'log'].includes(ext)) {
            fileIconClass = 'fa-file-alt';
        } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
            fileIconClass = 'fa-file-image';
        } else if (['pdf'].includes(ext)) {
            fileIconClass = 'fa-file-pdf';
        } else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) {
            fileIconClass = 'fa-file-archive';
        }

        listItem.innerHTML = `
            <i class="fa ${fileIconClass} file-icon me-2"></i>
            <a href="#${entry.path}" class="file-name" data-file-id="${entry.id}" data-branch="${currentBranch}">${escapeHtml(entry.name)}</a>
            <span class="commit-msg text-muted ms-auto">Updated recently</span> `;

        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            loadFile(this.dataset.fileId); // Load file by its unique ID
        });
        fileListElement.appendChild(listItem);
    });

    // Handle empty directory
    if (dirEntries.length === 0 && fileEntries.length === 0 && currentPath === '') {
        if (fileListElement.children.length === 0) {
            fileListElement.innerHTML = '<li class="file-item text-muted p-3">This repository is empty.</li>';
        }
    } else if (dirEntries.length === 0 && fileEntries.length === 0 && currentPath !== '') {
        if (fileListElement.children.length <= 1) {
            const emptyMsg = document.createElement('li');
            emptyMsg.className = 'file-item text-muted p-3';
            emptyMsg.textContent = 'This directory is empty.';
            fileListElement.appendChild(emptyMsg);
        }
    }

    // Update breadcrumb display
    updateBreadcrumbPath(currentPath);
}

// Update breadcrumb display
function updateBreadcrumbPath(path) {
    const currentPathElement = document.getElementById('currentPath');
    currentPathElement.innerHTML = ''; // Clear existing breadcrumbs

    // Always add the root project link
     const projectLink = document.createElement('a');
     projectLink.href = '#project-root';
     projectLink.textContent = escapeHtml(currentProject?.name || 'Project'); // Use loaded project name
     projectLink.dataset.path = ''; // Root path is empty string
     projectLink.addEventListener('click', function(e) {
         e.preventDefault();
         navigateToPath(this.dataset.path);
     });
     currentPathElement.appendChild(projectLink);


    if (!path || path === '') {
        // We are at the root, project name is already added
        return;
    }

    // Add path segments
    const segments = path.split('/');
    let accumulatedPath = '';

    segments.forEach((segment, index) => {
        if (!segment) return; // Skip empty segments

        accumulatedPath += (accumulatedPath ? '/' : '') + segment;

        // Add separator
        const separator = document.createElement('span');
        separator.textContent = ' / ';
        separator.className = 'mx-1'; // Add some spacing
        currentPathElement.appendChild(separator);

        if (index === segments.length - 1) {
            // Last segment - display as text
            const span = document.createElement('span');
            span.textContent = escapeHtml(segment);
            span.className = 'fw-bold'; // Make last part bold
            currentPathElement.appendChild(span);
        } else {
            // Intermediate segment - make clickable link
            const link = document.createElement('a');
            link.href = `#${accumulatedPath}`;
            link.textContent = escapeHtml(segment);
            link.dataset.path = accumulatedPath;
            link.addEventListener('click', function(e) {
                e.preventDefault();
                navigateToPath(this.dataset.path);
            });
            currentPathElement.appendChild(link);
        }
    });
}


// Navigate to a directory path within the current branch
function navigateToPath(path) {
    console.log(`Navigating to path: "${path}"`);
    currentPath = path;
    // Re-display files using the existing projectFiles for the current branch
    // The buildFileTree function is called within displayFiles if needed,
    // but ideally, we rebuild the tree only when switching branches.
    // For navigation, we just traverse the existing tree structure.
    displayFiles(buildFileTree(projectFiles)); // Re-render the file list for the new path
    document.getElementById('codeContainer').style.display = 'none'; // Hide code view when navigating folders
}

// Load specific file content by ID
async function loadFile(fileId) {
    console.log(`Loading file ID: ${fileId} for branch: ${currentBranch}`);
    const codeTableBody = document.querySelector('#codeTable tbody'); 
    const currentFileNameElement = document.getElementById('currentFileName');
    const codeContainerElement = document.getElementById('codeContainer');

    // Show loading state in code view
    currentFileNameElement.textContent = 'Loading file...';
    if (codeTableBody) codeTableBody.innerHTML = '<tr><td colspan="2" class="text-center p-3 text-muted">Loading...</td></tr>';
    codeContainerElement.style.display = 'block'; 

    try {
        // Find the branch ID by name
        const branch = projectBranches.find(b => b.name === currentBranch);
        if (!branch || !branch.id) {
            throw new Error(`Could not find branch ID for branch: ${currentBranch}`);
        }

        // Use branch-specific endpoint
        const response = await fetch(`/api/files/${fileId}?branchId=${branch.id}`, { 
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                const file = result.data;
                displayFileContent(file); 
            } else {
                throw new Error(result.message || 'Failed to load file content from API');
            }
        } else {
             throw new Error(`HTTP error ${response.status} loading file content`);
        }
    } catch (error) {
        console.error('Error loading file content:', error);
        currentFileNameElement.textContent = 'Error loading file';
        if (codeTableBody) codeTableBody.innerHTML = `<tr><td colspan="2"><div class="alert alert-danger m-2">Failed to load file: ${error.message}</div></td></tr>`;
    }
}


// Display file content in the code view
function displayFileContent(file) {
    const currentFileNameElement = document.getElementById('currentFileName');
    const codeTableBody = document.querySelector('#codeTable tbody'); // Target tbody
    const codeContainerElement = document.getElementById('codeContainer');
    const rawButton = document.getElementById('rawButton');
    const downloadButton = document.getElementById('downloadButton');
    const modalFileName = document.getElementById('modalFileName');
    const modalCode = document.getElementById('modalCode');


    if (!codeTableBody || !currentFileNameElement || !codeContainerElement || !rawButton || !downloadButton || !modalFileName || !modalCode) {
        console.error("One or more elements for code display are missing.");
        return;
    }

    // Update file name display
    currentFileNameElement.textContent = escapeHtml(file.name);

    // Clear previous content
    codeTableBody.innerHTML = '';

    // Process file content
    const fileContent = file.content ?? ''; // Use empty string if content is null/undefined
    const lines = fileContent.split('\n');

    // Handle empty file case
    if (lines.length === 1 && lines[0] === '') {
         const row = codeTableBody.insertRow();
         const lineNumberCell = row.insertCell();
         lineNumberCell.className = 'line-number';
         lineNumberCell.textContent = '1';
         lineNumberCell.dataset.lineNumber = '1';

         const lineContentCell = row.insertCell();
         lineContentCell.className = 'line-content';
         lineContentCell.innerHTML = '<span class="text-muted">(empty file)</span>'; // Indicate empty file
    } else {
         // Build the code table with line numbers
        lines.forEach((line, index) => {
            const row = codeTableBody.insertRow(); // Use insertRow for table body

            // Line number cell
            const lineNumberCell = row.insertCell(); // Use insertCell
            lineNumberCell.className = 'line-number';
            lineNumberCell.textContent = index + 1;
            lineNumberCell.dataset.lineNumber = index + 1; // For potential linking/highlighting

            // Line content cell - this is where the fix is needed
            const lineContentCell = row.insertCell(); // Use insertCell
            lineContentCell.className = 'line-content';
            
            // FIX: Don't wrap content in nested pre/code tags, just use the cell directly
            // Instead of creating a pre>code structure, use the proper CSS to maintain formatting
            lineContentCell.textContent = line; // Set raw line text directly
            
            // Determine language - use this for possible syntax highlighting in the future
            const ext = file.name.split('.').pop().toLowerCase();
            const langClass = getHighlightLanguageClass(ext); // Get class name
            if (langClass) {
                lineContentCell.classList.add(`language-${langClass}`);
            }
        });
    }


    // Set up action buttons
    // Adjust API endpoint for raw/download if needed
    rawButton.href = `/api/files/${file.id}/raw?token=${token}`; // Example: Pass token if needed by API
    downloadButton.href = `/api/files/${file.id}/raw?token=${token}`; // Example: Pass token if needed by API
    downloadButton.download = file.name;

    // Update modal data for full screen view - this is working correctly
    modalFileName.textContent = escapeHtml(file.name);
    modalCode.textContent = fileContent; // Use the raw content for the modal
    const modalLangClass = getHighlightLanguageClass(file.name.split('.').pop().toLowerCase());
    modalCode.className = modalLangClass ? `language-${modalLangClass}` : ''; // Set class for modal highlighting
    if (window.hljs && modalLangClass) {
        hljs.highlightElement(modalCode); // Highlight modal content too
    }


    // Ensure code container is visible
    codeContainerElement.style.display = 'block';

    // Optional: Scroll code container or page to top
    codeContainerElement.querySelector('.code-content').scrollTop = 0; // Scroll code content div
}

// Helper function to get highlight.js language class
function getHighlightLanguageClass(ext) {
    const languageMap = {
        'js': 'javascript', 'jsx': 'javascript', 'ts': 'typescript', 'tsx': 'typescript',
        'html': 'xml', 'xml': 'xml', // Use XML for HTML highlighting often works well
        'css': 'css', 'scss': 'scss', 'sass': 'scss', 'less': 'less',
        'java': 'java', 'py': 'python', 'rb': 'ruby', 'php': 'php',
        'c': 'c', 'cpp': 'cpp', 'h': 'cpp', 'cs': 'csharp',
        'go': 'go', 'rs': 'rust', 'swift': 'swift', 'kt': 'kotlin',
        'md': 'markdown', 'json': 'json', 'yml': 'yaml', 'yaml': 'yaml',
        'sql': 'sql', 'sh': 'bash', 'bat': 'batch', 'ps1': 'powershell',
        'dockerfile': 'dockerfile', 'properties': 'properties', 'gradle': 'gradle',
        'txt': 'plaintext', '': 'plaintext' // Handle no extension or treat as text
    };
    return languageMap[ext] || 'plaintext'; // Default to plaintext
}


// Apply syntax highlighting (Now primarily used for the modal)
function applyCodeHighlighting(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const language = getHighlightLanguageClass(ext); // Use helper

    const modalCode = document.getElementById('modalCode');
    if (modalCode && language) {
        modalCode.className = `language-${language}`;
        if (window.hljs) {
            window.hljs.highlightElement(modalCode);
        }
    }
}

// Toggle star status (using localStorage for simulation)
function toggleStar() {
    if (!projectId) return;
    const projectIdNum = parseInt(projectId); // Ensure it's a number if IDs are numeric
    let starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
    const starButton = document.getElementById('starBtn'); // Use the correct ID

    if (starredRepoIds.includes(projectIdNum)) {
        // Unstar
        starredRepoIds = starredRepoIds.filter(id => id !== projectIdNum);
        if(starButton) starButton.innerHTML = `<i class="fa fa-star-o"></i> Star`;
        showToast('Repository unstarred.', 'info'); // Use info toast
    } else {
        // Star
        starredRepoIds.push(projectIdNum);
         if(starButton) starButton.innerHTML = `<i class="fa fa-star"></i> Unstar`;
         showToast('Repository starred!', 'success');
    }
    localStorage.setItem('starredRepos', JSON.stringify(starredRepoIds));
    // Update count if you have a star count element
}

// Fork repository (simulation)
function forkRepository() {
    if (!projectId) return;
    // Add actual API call here in a real application
    console.log(`Forking project ID: ${projectId}`);
    showToast('Repository forked successfully! (Simulation)', 'success');
    // Maybe update fork count display if available
}

// Update star button UI based on localStorage
function updateStarButton() {
    if (!projectId) return;
    const projectIdNum = parseInt(projectId);
    const starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
    const isStarred = starredRepoIds.includes(projectIdNum);
    const starButton = document.getElementById('starBtn'); // Use the correct ID

    if (starButton) {
        starButton.innerHTML = isStarred
            ? '<i class="fa fa-star"></i> Unstar'
            : '<i class="fa fa-star-o"></i> Star';
    }
}

// Setup ALL event listeners
function setupEventListeners() {
    console.log("Setting up event listeners...");

    // --- Tab Switching Logic ---
    const tabs = [filesTab, commitsTab, pullRequestsTab, issuesTab];
    const containers = {
        filesTab: [fileExplorerContainer, codeContainer], // Files tab shows explorer OR code view
        commitsTab: [commitsContainer],
        pullRequestsTab: [pullRequestsContainer],
        issuesTab: [] // Add issuesContainer here if created
    };

    tabs.forEach(tab => {
        if (tab) {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const clickedTabId = this.id;

                // Update active tab style
                tabs.forEach(t => t?.classList.remove('active')); // Use optional chaining
                this.classList.add('active');

                // Hide all containers first
                 Object.values(containers).flat().forEach(container => {
                     if (container) container.style.display = 'none';
                 });

                // Show containers for the clicked tab
                if (containers[clickedTabId]) {
                    containers[clickedTabId].forEach(container => {
                        if (container) {
                            // Special handling for filesTab: only show fileExplorer initially
                            if (clickedTabId === 'filesTab' && container === fileExplorerContainer) {
                                container.style.display = 'block';
                            } else if (clickedTabId !== 'filesTab') {
                                container.style.display = 'block';
                            }
                            // codeContainer visibility is handled by loadFile/navigateToPath
                        }
                    });
                }

                // Load data if necessary
                if (clickedTabId === 'commitsTab') {
                    loadCommitHistory();
                } else if (clickedTabId === 'pullRequestsTab') {
                    loadPullRequests('OPEN'); // Load initial 'OPEN' PRs
                } else if (clickedTabId === 'issuesTab') {
                    // loadIssues(); // Call function to load issues
                    console.log("Issues tab clicked - implement functionality");
                }
                 else if (clickedTabId === 'filesTab') {
                     // When clicking back to Files tab, ensure file explorer is shown
                     // and code view is hidden if it was previously open.
                     if(fileExplorerContainer) fileExplorerContainer.style.display = 'block';
                     if(codeContainer) codeContainer.style.display = 'none';
                     // Optionally reload files if needed, though maybe not necessary unless branch changed
                     // displayFiles(buildFileTree(projectFiles)); // Re-render based on current path
                 }
            });
        }
    });


    // --- Branch Dropdown Logic ---
    if (branchButton) {
        branchButton.addEventListener('click', function() {
            branchDropdown.style.display = branchDropdown.style.display === 'block' ? 'none' : 'block';
             if(branchDropdown.style.display === 'block') branchSearchInput.focus();
        });
    }
    if (branchSearchInput) {
        branchSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const branchItems = branchList.querySelectorAll('.branch-item');
            branchItems.forEach(item => {
                const branchName = item.querySelector('.branch-name')?.textContent.toLowerCase() || '';
                item.style.display = branchName.includes(searchTerm) ? 'flex' : 'none';
            });
        });
    }
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (branchButton && branchDropdown && !branchButton.contains(event.target) && !branchDropdown.contains(event.target)) {
            branchDropdown.style.display = 'none';
        }
    });

    // --- Visibility Toggle Logic ---
    const makePublicOption = document.getElementById('makePublicOption');
    const makePrivateOption = document.getElementById('makePrivateOption');
    if(makePublicOption) makePublicOption.addEventListener('click', (e) => { e.preventDefault(); toggleProjectVisibility(true); });
    if(makePrivateOption) makePrivateOption.addEventListener('click', (e) => { e.preventDefault(); toggleProjectVisibility(false); });

    // --- Star/Fork Button Logic ---
     const starButton = document.getElementById('starBtn');
     const forkButton = document.getElementById('forkBtn');
     if(starButton) starButton.addEventListener('click', toggleStar);
     if(forkButton) forkButton.addEventListener('click', forkRepository);


    // --- Code Action Buttons Logic ---
    const copyButton = document.getElementById('copyButton');
    const fullScreenButton = document.getElementById('fullScreenButton');

    if (copyButton) {
        copyButton.addEventListener('click', function(e) {
            e.preventDefault();
            const codeContent = Array.from(document.querySelectorAll('#codeTable .line-content code'))
                                     .map(code => code.textContent)
                                     .join('\n');
            navigator.clipboard.writeText(codeContent).then(() => {
                showToast('Content copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                 showToast('Failed to copy content.', 'error');
            });
        });
    }

    if (fullScreenButton && fullScreenModal) {
        fullScreenButton.addEventListener('click', function(e) {
            e.preventDefault();
            fullScreenModal.style.display = 'block';
            // Ensure highlighting is applied when modal opens
             const modalCode = document.getElementById('modalCode');
             if (window.hljs && modalCode.className.includes('language-')) {
                  hljs.highlightElement(modalCode);
             }
        });
    }

    // --- Modal Close Logic ---
    if (modalClose && fullScreenModal) {
        modalClose.addEventListener('click', () => { fullScreenModal.style.display = 'none'; });
    }
    // Close modal on outside click
    window.addEventListener('click', (event) => {
        if (fullScreenModal && event.target === fullScreenModal) {
            fullScreenModal.style.display = 'none';
        }
    });

     // --- Pull Request Status Tabs ---
     document.querySelectorAll('.card-header-tabs .nav-link[data-pr-status]').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.card-header-tabs .nav-link[data-pr-status]').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
            const status = this.getAttribute('data-pr-status');
            loadPullRequests(status);
        });
    });

     // --- New Pull Request Button ---
     const newPRButton = document.getElementById('newPRButton');
    if (newPRButton) {
        newPRButton.addEventListener('click', function() {
            if (projectId) {
                // Changed to navigate to new-pull-request.html with projectId parameter
                // This avoids the need for a pull request ID when creating a new one
                window.location.href = `/new-pull-request.html?projectId=${projectId}`;
            } else {
                console.error("Project ID not found for New PR button");
                alert("Could not determine the project ID.");
            }
        });
    }

     console.log("Event listeners setup complete.");
}


// Toggle project visibility
async function toggleProjectVisibility(makePublic) {
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isPublic: makePublic }) // Ensure body field matches API expectation
        });

        const result = await response.json();

        if (response.ok && result.success) {
            updateVisibilityDisplay(makePublic); // Update UI elements
            const message = makePublic
                ? 'Repository is now public.'
                : 'Repository is now private.';
            showToast(message, 'success');
            // Update the global project object if necessary
            if (currentProject) currentProject.isPublic = makePublic;
             document.getElementById('projectVisibility').textContent = makePublic ? 'Public' : 'Private'; // Update stats display
        } else {
            throw new Error(result.message || 'Failed to update project visibility');
        }
    } catch (error) {
        console.error('Error updating project visibility:', error);
        showToast(`Failed to update repository visibility: ${error.message}`, 'error');
    }
}

// Update visibility display elements
function updateVisibilityDisplay(isPublic) {
    const visibilityBtnIcon = document.getElementById('visibilityBtnIcon');
    const visibilityBtnText = document.getElementById('visibilityBtnText');
    const makePublicOption = document.getElementById('makePublicOption');
    const makePrivateOption = document.getElementById('makePrivateOption');
    const projectVisibilityStat = document.getElementById('projectVisibility'); // The stat element

    if (isPublic) {
        if(visibilityBtnIcon) visibilityBtnIcon.className = 'fa fa-globe me-1'; // Add margin
        if(visibilityBtnText) visibilityBtnText.textContent = 'Public';
        if(projectVisibilityStat) projectVisibilityStat.textContent = 'Public';
        if(makePublicOption) makePublicOption.style.display = 'none'; // Hide "Make Public"
        if(makePrivateOption) makePrivateOption.style.display = 'block'; // Show "Make Private"
    } else {
        if(visibilityBtnIcon) visibilityBtnIcon.className = 'fa fa-lock me-1'; // Add margin
        if(visibilityBtnText) visibilityBtnText.textContent = 'Private';
         if(projectVisibilityStat) projectVisibilityStat.textContent = 'Private';
        if(makePublicOption) makePublicOption.style.display = 'block'; // Show "Make Public"
        if(makePrivateOption) makePrivateOption.style.display = 'none'; // Hide "Make Private"
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    // Ensure toast container exists
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        // Use Bootstrap positioning classes for bottom-right
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1100'; // Ensure high z-index
        document.body.appendChild(toastContainer);
    }

    const toastId = `toast-${Date.now()}`; // Unique ID for the toast
    const toast = document.createElement('div');
    toast.id = toastId;
    // Base Bootstrap toast classes + custom type
    toast.className = `toast align-items-center text-white border-0 toast-${type}`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    // Set background color based on type
     let bgColorClass = 'bg-secondary'; // Default
     if (type === 'success') bgColorClass = 'bg-success';
     else if (type === 'error') bgColorClass = 'bg-danger';
     else if (type === 'warning') bgColorClass = 'bg-warning text-dark'; // Warning might need dark text
     else if (type === 'info') bgColorClass = 'bg-info text-dark'; // Info might need dark text
     toast.classList.add(bgColorClass);


    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${escapeHtml(message)}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Initialize Bootstrap toast
    const bootstrapToast = new bootstrap.Toast(toast, { delay: 3000 }); // Auto-hide after 3 seconds
    bootstrapToast.show();

    // Optional: Remove the element after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}


// --- Pull Request Functions ---
async function loadPullRequests(status = 'OPEN') {
    if (!projectId) return;
    const pullRequestsList = document.getElementById('pullRequestsList');
    if (!pullRequestsList) return;

    pullRequestsList.innerHTML = `
        <div class="list-group-item text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div> Loading pull requests...
        </div>`;

    try {
        const response = await fetch(`/api/pull-requests/project/${projectId}?status=${status}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const data = await response.json();
        if (data.success && Array.isArray(data.data)) {
            displayPullRequests(data.data);
        } else {
             console.warn("No PR data received or invalid format:", data);
            pullRequestsList.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <p class="mb-0 text-muted">No ${status.toLowerCase()} pull requests found.</p>
                </div>`;
        }
    } catch (error) {
        console.error('Error loading pull requests:', error);
        pullRequestsList.innerHTML = `
            <div class="list-group-item text-center py-4">
                <p class="mb-0 text-danger">Failed to load pull requests: ${error.message}</p>
            </div>`;
    }
}

function displayPullRequests(pullRequests) {
    const pullRequestsList = document.getElementById('pullRequestsList');
    if (!pullRequestsList) return;

    if (pullRequests.length === 0) {
        // Get the currently active status tab to display a more specific message
        const activeStatusTab = document.querySelector('.card-header-tabs .nav-link.active');
        const status = activeStatusTab ? activeStatusTab.getAttribute('data-pr-status') : 'selected';
        pullRequestsList.innerHTML = `
            <div class="list-group-item text-center py-4">
                <i class="fa fa-code-pull-request fa-2x text-muted mb-2"></i>
                <p class="mb-0 text-muted">No ${status.toLowerCase()} pull requests found.</p>
            </div>`;
        return;
    }

    pullRequestsList.innerHTML = '';

    pullRequests.forEach(pr => {
        let statusClass = 'bg-secondary';
        let statusIcon = 'fa-circle-question'; // Default icon
        if (pr.status === 'OPEN') {
            statusClass = 'text-success'; // Use text color for open
            statusIcon = 'fa-code-pull-request';
        } else if (pr.status === 'MERGED') {
            statusClass = 'text-info'; // Use text color for merged
            statusIcon = 'fa-code-merge';
        } else if (pr.status === 'CLOSED') {
             statusClass = 'text-danger'; // Use text color for closed
             statusIcon = 'fa-xmark-circle'; // Or fa-ban
        }

        const listItem = document.createElement('a');
        // Update this href if you have a dedicated PR view page
        listItem.href = `/pull-request.html?id=${pr.id}&projectId=${projectId}`;
        listItem.className = 'list-group-item list-group-item-action d-flex align-items-center';

        listItem.innerHTML = `
            <i class="fa ${statusIcon} ${statusClass} fa-lg me-3"></i>
            <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">${escapeHtml(pr.title)}</h6>
                <small class="text-muted d-block">
                    #${pr.id} opened ${timeAgo(new Date(pr.createdAt))} by ${escapeHtml(pr.author?.username || 'Unknown')}
                     Â· ${pr.sourceBranch || '?'} â†’ ${pr.targetBranch || '?'}
                </small>
                 ${pr.description ? `<p class="mb-0 mt-1 text-muted text-small">${escapeHtml(pr.description.substring(0, 100))}${pr.description.length > 100 ? '...' : ''}</p>` : ''}
            </div>
            `;
        pullRequestsList.appendChild(listItem);
    });
}

// --- Commit History Functions ---
async function loadCommitHistory() {
     const commitsListElement = document.getElementById('commitsList');
     if (!commitsListElement) return;

    commitsListElement.innerHTML = `
        <div class="text-center py-4">
             <div class="spinner-border spinner-border-sm text-primary" role="status">
                 <span class="visually-hidden">Loading...</span>
             </div> Loading commit history...
        </div>`;

    try {
        console.log("Loading commit history for branch:", currentBranch);
        const branch = projectBranches.find(b => b.name === currentBranch);
        const branchId = branch ? branch.id : null;

        if (!branchId && projectBranches.length > 0) {
             console.warn("Could not find ID for current branch name, API call might fail or use name.");
             // Decide if you want to proceed without ID or show error
        }
         if (!branchId && projectBranches.length === 0) {
             throw new Error("No branches available to fetch commits for.");
         }

        // *** Adjust API endpoint as needed ***
        // Example: /api/version-control/commits?projectId=X&branchId=Y or &branchName=main
        const apiUrl = branchId
            ? `/api/version-control/commit-history?branchId=${branchId}`
            : `/api/version-control/commit-history?projectId=${projectId}&branchName=${encodeURIComponent(currentBranch)}`; // Fallback using name

        const response = await fetch(apiUrl, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const result = await response.json();
        console.log("Commit history response:", result);

        if (result.success && Array.isArray(result.data)) {
            displayCommits(result.data);
        } else {
             console.warn("No commit data received or invalid format:", result);
             commitsListElement.innerHTML = `
                 <div class="list-group-item text-center py-4">
                     <i class="fa fa-history fa-2x text-muted mb-2"></i>
                     <p class="mb-0 text-muted">No commits found for the '${escapeHtml(currentBranch)}' branch.</p>
                 </div>`;
        }
    } catch (error) {
        console.error('Error loading commits:', error);
        commitsListElement.innerHTML = `
            <div class="list-group-item text-center py-4">
                 <p class="mb-0 text-danger">Failed to load commits: ${error.message}</p>
             </div>`;
    }
}

function displayCommits(commits) {
    const commitsList = document.getElementById('commitsList');
    if (!commitsList) return;

    if (!commits || commits.length === 0) {
        commitsList.innerHTML = `
             <div class="list-group-item text-center py-4">
                 <i class="fa fa-history fa-2x text-muted mb-2"></i>
                 <p class="mb-0 text-muted">No commits found for this branch.</p>
             </div>`;
        return;
    }

    commitsList.innerHTML = ''; // Clear loading/previous

    // Group commits by date (optional but nice)
    const commitsByDate = commits.reduce((acc, commit) => {
        const date = new Date(commit.createdAt).toLocaleDateString();
        if (!acc[date]) {
            acc[date] = [];
        }
        acc[date].push(commit);
        return acc;
    }, {});

    // Display commits grouped by date
    Object.keys(commitsByDate).sort((a,b) => new Date(b) - new Date(a)).forEach(date => { // Sort dates descending
         // Add date header
         const dateHeader = document.createElement('div');
         dateHeader.className = 'list-group-item bg-light py-1 px-3 fw-bold text-muted text-small sticky-top'; // Make date header sticky
         dateHeader.style.top = '0'; // Adjust based on navbar height if fixed
         dateHeader.textContent = `Commits on ${new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}`;
         commitsList.appendChild(dateHeader);

         // Add commits for this date
         commitsByDate[date].forEach(commit => {
            const commitDate = new Date(commit.createdAt);
            const formattedTime = commitDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const authorUsername = commit.author?.username || 'Unknown';
            const commitIdShort = commit.id.toString().substring(0, 7); // Short commit hash

            const commitItem = document.createElement('div');
            commitItem.className = 'list-group-item list-group-item-action commit-item'; // Use list-group-item for consistency

            commitItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1 me-3">
                        <a href="#" class="fw-bold text-dark text-decoration-none commit-title-link" data-commit-id="${commit.id}">
                            ${escapeHtml(commit.message || "No commit message")}
                        </a>
                        <div class="commit-meta text-muted text-small mt-1">
                            <img src="https://www.gravatar.com/avatar/${hashString(authorUsername)}?d=mp&s=20"
                                 alt="${escapeHtml(authorUsername)}" class="avatar-img-small me-1">
                            <strong>${escapeHtml(authorUsername)}</strong> authored ${timeAgo(commitDate)}
                        </div>
                    </div>
                    <div class="text-end">
                         <button class="btn btn-sm btn-outline-secondary view-details-btn"
                                 data-commit-id="${commit.id}" title="View commit details">
                             <i class="fa fa-code"></i> ${commitIdShort}
                         </button>
                         </div>
                </div>
            `;

             // Add click listener to the button AND the title link
             commitItem.querySelector('.view-details-btn').addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation(); // Prevent triggering other listeners if nested
                  viewCommitDetails(commit.id);
             });
              commitItem.querySelector('.commit-title-link').addEventListener('click', (e) => {
                  e.preventDefault();
                  viewCommitDetails(commit.id);
             });

            commitsList.appendChild(commitItem);
        });
     });

    // setupBatchCommitViewing(); // Re-enable if needed
}

// View Commit Details (Redirects to a new page)
function viewCommitDetails(commitId) {
    if (!commitId || !projectId) {
        console.error("Missing commitId or projectId for viewing details.");
        return;
    }
    // Redirect to a dedicated commit details page
    window.location.href = `/commit-details.html?id=${commitId}&projectId=${projectId}`;
}

// --- Language Stats Functions ---
const languageColors = { /* Keep your languageColors object */
    'HTML': '#e34c26', 'Java': '#b07219', 'JavaScript': '#f1e05a', 'TypeScript': '#2b7489',
    'CSS': '#563d7c', 'Python': '#3572A5', 'Ruby': '#701516', 'PHP': '#4F5D95',
    'C': '#555555', 'C++': '#f34b7d', 'C#': '#178600', 'Shell': '#89e051',
    'Batch': '#C1F12E', 'PowerShell': '#012456', 'Go': '#00ADD8', 'Kotlin': '#F18E33',
    'Swift': '#ffac45', 'Rust': '#dea584', 'Gradle': '#02303A', 'XML': '#0060ac',
    'JSON': '#292929', 'Markdown': '#083fa1', 'Text': '#cccccc', 'YAML': '#cb171e',
    'Other': '#8b949e'
};

async function loadLanguageStats() {
    const languageBars = document.getElementById('language-bars');
    const languageList = document.getElementById('language-list');
    const loadingBar = document.getElementById('language-bar-loading');
    const languagesContainer = document.querySelector('.languages-container'); // Get the main container

    if (!languageBars || !languageList || !loadingBar || !languagesContainer) {
         console.warn("Language stats elements not found.");
         if(languagesContainer) languagesContainer.style.display = 'none'; // Hide container if elements missing
         return;
    }

    // Show loading state
    loadingBar.style.display = 'block';
    languageBars.style.display = 'none';
    languageList.innerHTML = ''; // Clear list while loading
    languagesContainer.style.display = 'block'; // Ensure container is visible

    try {
        if (!projectId) throw new Error('Project ID not found');

        const response = await fetch(`/api/projects/${projectId}/languages`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const result = await response.json();
        if (!result.success || typeof result.data !== 'object') { // Check if data is an object
            throw new Error('Invalid language data format from server');
        }

        const languageData = result.data;
        if (Object.keys(languageData).length === 0) {
            languageList.innerHTML = '<li class="text-muted text-small">No language data available.</li>';
            loadingBar.style.display = 'none'; // Hide loading even if empty
            languageBars.style.display = 'flex'; // Show empty bar container
            languageBars.innerHTML = '<div class="language-bar" style="width: 100%; background-color: #eee;"></div>'; // Optional: show gray bar
            return;
        }

        const sortedLanguages = Object.entries(languageData).sort((a, b) => b[1] - a[1]);

        // Generate bars
        let barsHtml = '';
        sortedLanguages.forEach(([language, percentage]) => {
            const color = languageColors[language] || languageColors['Other'];
            barsHtml += `<div class="language-bar"
                             style="width: ${percentage}%; background-color: ${color};"
                             title="${escapeHtml(language)}: ${percentage.toFixed(1)}%"></div>`;
        });
        languageBars.innerHTML = barsHtml;

        // Generate list
        sortedLanguages.forEach(([language, percentage]) => {
            if (percentage >= 0.1) { // Threshold for displaying
                const color = languageColors[language] || languageColors['Other'];
                const listItem = document.createElement('li');
                listItem.className = 'language-item';
                listItem.innerHTML = `
                    <span class="language-color" style="background-color: ${color};"></span>
                    <span class="language-name">${escapeHtml(language)}</span>
                    <span class="language-percentage">${percentage.toFixed(1)}%</span>
                `;
                languageList.appendChild(listItem);
            }
        });

        // Hide loading, show content
        loadingBar.style.display = 'none';
        languageBars.style.display = 'flex';

    } catch (error) {
        console.error('Error loading language statistics:', error);
        languageList.innerHTML = `<li class="text-muted text-small">Error loading stats.</li>`;
        loadingBar.style.display = 'none'; // Hide loading on error
         languageBars.style.display = 'flex';
         languageBars.innerHTML = '<div class="language-bar bg-danger" style="width: 100%;" title="Error loading stats"></div>'; // Show error bar
    }
}


// --- Utility Functions --- (Keep timeAgo, hashString, escapeHtml)
function timeAgo(date) {
    if (!(date instanceof Date)) date = new Date(date); // Ensure it's a Date object
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = Math.floor(seconds / 31536000);
    if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";
    interval = Math.floor(seconds / 2592000);
    if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";
    interval = Math.floor(seconds / 86400);
    if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
    interval = Math.floor(seconds / 3600);
    if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
    interval = Math.floor(seconds / 60);
    if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
    const roundedSeconds = Math.floor(seconds);
    return roundedSeconds + " second" + (roundedSeconds === 1 ? "" : "s") + " ago";
}


// --- Initial Load Trigger ---
// Use DOMContentLoaded to ensure elements exist before running scripts
document.addEventListener('DOMContentLoaded', initialize);

</script>

</body>
</html>