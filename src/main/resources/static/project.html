<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View - Code Sharing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- Add these lines in the head section of your project.html file -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">Code Sharing Platform</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Project</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-light me-3" id="userInfo">Loading...</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Project Header -->
        <div class="gh-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 id="projectTitle">Loading project...</h1>
                    <p class="description" id="projectDescription"></p>
                </div>
                <div class="d-flex gap-2">
                    <button class="gh-btn">
                        <i class="fa fa-star"></i> Star
                    </button>
                    <button class="gh-btn">
                        <i class="fa fa-code-fork"></i> Fork
                    </button>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="dropdown">
                    <button class="gh-btn dropdown-toggle" id="visibilityToggleBtn" data-bs-toggle="dropdown">
                        <i class="fa fa-lock" id="visibilityBtnIcon"></i>
                        <span id="visibilityBtnText">Private</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="makePublicOption">
                            <i class="fa fa-globe me-2"></i> Make public
                            <div class="small text-muted mt-1">Anyone on the internet can see this repository</div>
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="makePrivateOption">
                            <i class="fa fa-lock me-2"></i> Make private
                            <div class="small text-muted mt-1">You choose who can see and commit to this repository</div>
                        </a></li>
                    </ul>
                </div>
                <button class="gh-btn" id="starBtn">
                    <i class="fa fa-star-o"></i> Star
                </button>
                <button class="gh-btn" id="forkBtn">
                    <i class="fa fa-code-fork"></i> Fork
                </button>
            </div>
            
            <div class="repo-stats">
                <div class="repo-stat">
                    <i class="fa fa-code-branch"></i>
                    <span id="branchCount">0</span> branches
                </div>
                <div class="repo-stat">
                    <i class="fa fa-tag"></i>
                    <span>0</span> tags
                </div>
                <div class="repo-stat">
                    <i class="fa fa-code"></i>
                    <span id="fileCount">0</span> files
                </div>
                <div class="repo-stat">
                    <i class="fa fa-user"></i>
                    Owner: <span id="projectOwner"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-calendar"></i>
                    Created: <span id="projectCreated"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-eye"></i>
                    <span id="projectVisibility"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb and Branch Selector -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item" id="projectNameBreadcrumb"></li>
                    <li class="breadcrumb-item active" id="currentPath">.</li>
                </ol>
            </nav>
            
            <div class="branch-dropdown">
                <button class="branch-selector dropdown-toggle" id="branchButton">
                    <i class="fa fa-code-branch"></i>
                    <span id="currentBranch">main</span>
                </button>
                <div class="branch-dropdown-content" id="branchDropdown">
                    <div class="branch-search">
                        <input type="text" placeholder="Find a branch..." id="branchSearchInput">
                    </div>
                    <div class="branch-dropdown-header">Branches</div>
                    <div class="branch-list" id="branchList">
                        <!-- Branch items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Repository navigation tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" id="filesTab">Files</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="commitsTab">Commits</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="pullRequestsTab">Pull Requests</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" id="issuesTab">Issues</a>
            </li>
        </ul>
        
        <!-- File Explorer -->
        <div class="file-explorer mb-4">
            <div class="file-explorer-header">
                <div class="commit-info">
                    <img src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="User" class="commit-avatar">
                    <span id="lastCommitUser">User</span>
                    committed <span id="lastCommitTime">recently</span>
                </div>
                <a href="#" class="text-small text-decoration-none" id="commitsLink">
                    <i class="fa fa-history"></i> History
                </a>
            </div>
            
            <ul class="file-list" id="fileList">
                <!-- File items will be added here dynamically -->
                <li class="dir-item">
                    <i class="fa fa-folder file-icon file-dir-icon"></i>
                    <a href="#" class="dir-name">Loading...</a>
                </li>
            </ul>
        </div>

    <!-- Replace the existing languages section with this code -->
    <div class="languages-container">
        <h3 class="section-title">Languages</h3>
        <div class="language-bar-container">
        <!-- Loading state will be replaced by actual bars -->
        <div class="language-bar-loading" id="language-bar-loading"></div>
        <!-- Language bars will be added here dynamically -->
        <div class="language-bars" id="language-bars" style="display:none;"></div>
        </div>
        <ul class="language-list" id="language-list">
        <!-- Languages will be added here dynamically -->
        </ul>
    </div>

        <!-- Commits Container (Hidden by default) -->
<div class="commits-container" id="commitsContainer" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Commit History</h4>
        <div class="d-flex align-items-center">
            <div class="dropdown me-2">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="branchFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-code-branch me-1"></i>
                    <span id="currentBranchFilter">Current Branch</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="branchFilterDropdown" id="branchFilterList">
                    <!-- Branch items will be added dynamically -->
                </ul>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="commitFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-filter me-1"></i> Filter
                </button>
                <ul class="dropdown-menu" aria-labelledby="commitFilterDropdown">
                    <li><a class="dropdown-item" href="#" data-filter="all">All Commits</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="my-commits">My Commits</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" data-filter="recent">Last 7 Days</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="month">Last 30 Days</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="commitsList" class="commits-list">
        <!-- Commits will be loaded here -->
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

        <!-- Pull Requests Container (Hidden by default) -->
    <div class="pull-requests-container" id="pullRequestsContainer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Pull Requests</h4>
            <button class="btn btn-success" id="newPRButton">
                <i class="fa fa-plus me-1"></i> New Pull Request
            </button>
        </div>
    
    <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-pr-status="OPEN">Open</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-pr-status="CLOSED">Closed</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-pr-status="MERGED">Merged</a>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div id="pullRequestsList" class="list-group list-group-flush">
                    <!-- Pull Requests will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
        <!-- Code Display (Only visible when a file is selected) -->
        <div class="code-container" id="codeContainer" style="display: none;">
            <div class="code-header">
                <div class="code-header-filename" id="currentFileName">No file selected</div>
                <div class="code-header-actions">
                    <a href="#" id="rawButton"><i class="fa fa-file-code"></i> Raw</a>
                    <a href="#" id="downloadButton"><i class="fa fa-download"></i> Download</a>
                    <a href="#" id="copyButton"><i class="fa fa-copy"></i> Copy</a>
                    <a href="#" id="fullScreenButton"><i class="fa fa-expand"></i> Full screen</a>
                </div>
            </div>
            <div class="code-content">
                <table class="code-blob" id="codeTable">
                    <tbody>
                        <!-- Code content with line numbers will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- GitHub-like Modal for Full Screen View -->
    <div class="github-modal" id="fullScreenModal">
        <div class="github-modal-content">
            <div class="github-modal-header">
                <h3 class="github-modal-title" id="modalFileName">File Name</h3>
                <button class="github-modal-close">&times;</button>
            </div>
            <div class="github-modal-body">
                <pre><code id="modalCode"></code></pre>
            </div>
        </div>
    </div>
    <!-- Add this HTML for the commit details modal right before the closing body tag -->
    <div class="modal fade" id="commitDetailsModal" tabindex="-1" aria-labelledby="commitDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="commitDetailsModalLabel">Commit Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <div id="commitDetailsLoading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <div id="commitDetailsContent" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                <img id="commitAuthorAvatar" src="" alt="Author" class="avatar-img-medium me-2">
                <div>
                    <h5 id="commitMessage" class="mb-1"></h5>
                    <div class="text-muted">
                    <span id="commitAuthor"></span> committed on <span id="commitDate"></span>
                    </div>
                </div>
                </div>
                
                <div class="mb-4">
                <h6>Files Changed</h6>
                <div id="commitFilesList" class="list-group">
                    <!-- Files will be added here -->
                </div>
                </div>
                
                <div id="fileChangesContainer">
                <h6>File Changes</h6>
                <div id="fileChangesContent">
                    <!-- Code diff will be shown here -->
                </div>
                </div>
            </div>
            
            <div id="commitDetailsError" class="alert alert-danger" style="display: none;">
                Error loading commit details.
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<style>
    :root {
        --gh-border-color: #e1e4e8;
        --gh-bg-color: #f6f8fa;
        --gh-text-color: #24292e;
        --gh-link-color: #0366d6;
        --gh-secondary-text: #586069;
        --gh-file-line-active: #fffbdd;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        color: var(--gh-text-color);
        line-height: 1.5;
    }
    
    .navbar {
        background-color: #24292e;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        padding: 0.5rem 1rem;
    }
    
    .gh-header {
        padding: 24px 0;
        border-bottom: 1px solid var(--gh-border-color);
        margin-bottom: 16px;
    }
    
    .gh-header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 0;
    }
    
    .gh-header .description {
        font-size: 14px;
        color: var(--gh-secondary-text);
        margin-top: 8px;
    }
    
    .repo-stats {
        display: flex;
        gap: 16px;
        margin-top: 16px;
    }
    
    .repo-stat {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: var(--gh-secondary-text);
    }
    
    .branch-selector {
        background-color: var(--gh-bg-color);
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 5px 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gh-text-color);
        cursor: pointer;
    }
    
    .file-explorer {
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .file-explorer-header {
        background-color: var(--gh-bg-color);
        padding: 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .commit-info {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: var(--gh-secondary-text);
    }
    
    .commit-avatar {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 4px;
    }
    
    .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .file-item, .dir-item {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        align-items: center;
    }
    
    .file-item:hover, .dir-item:hover {
        background-color: #f8f9fa;
    }
    
    .file-item:last-child, .dir-item:last-child {
        border-bottom: none;
    }
    
    .file-icon {
        margin-right: 8px;
        color: var(--gh-secondary-text);
    }
    
    .file-dir-icon {
        color: #79b8ff;
    }
    
    .file-name {
        flex-grow: 1;
        font-size: 14px;
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .dir-name {
        flex-grow: 1;
        font-size: 14px;
        font-weight: 600;
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .commit-msg {
        font-size: 12px;
        color: var(--gh-secondary-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 400px;
        margin-left: auto;
        padding-left: 20px;
    }
    
    .code-container {
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .code-header {
        padding: 10px 16px;
        background-color: var(--gh-bg-color);
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .code-header-filename {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 14px;
        font-weight: 600;
    }
    
    .code-header-actions a {
        font-size: 14px;
        color: var(--gh-secondary-text);
        text-decoration: none;
        margin-left: 16px;
    }
    
    .code-content {
        overflow-x: auto;
    }
    
    .code-content pre {
        margin: 0;
        padding: 16px;
        overflow-y: hidden;
        background-color: white;
    }
    
    .code-content code {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 1.5;
        tab-size: 4;
    }
    
    .code-line-numbers {
        float: left;
        text-align: right;
        color: #aaa;
        border-right: 1px solid #e1e4e8;
        padding: 16px 8px 16px 16px;
        margin-right: 16px;
        user-select: none;
    }
    
    .breadcrumb-item a {
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: var(--gh-text-color);
    }
    
    /* Styles for directory tree */
    .directory-structure {
        list-style-type: none;
        padding-left: 0;
    }
    
    .directory-structure li {
        padding: 4px 0;
    }
    
    .directory-structure ul {
        list-style-type: none;
        padding-left: 20px;
    }
    
    .directory-toggle {
        cursor: pointer;
        user-select: none;
    }
    
    .directory-toggle::before {
        content: "â–¶";
        display: inline-block;
        width: 12px;
        transition: transform 0.2s;
    }
    
    .directory-toggle.open::before {
        transform: rotate(90deg);
    }
    
    .file-content {
        display: none;
    }
    
    /* GitHub-like UI elements */
    .gh-btn {
        display: inline-flex;
        align-items: center;
        background-color: var(--gh-bg-color);
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 5px 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gh-text-color);
        cursor: pointer;
        text-decoration: none;
        line-height: 20px;
    }
    
    .gh-btn:hover {
        background-color: #f3f4f6;
        text-decoration: none;
    }
    
    .gh-btn i {
        margin-right: 4px;
    }
    
    .gh-btn-primary {
        background-color: #2ea44f;
        border-color: rgba(27,31,35,0.15);
        color: white;
    }
    
    .gh-btn-primary:hover {
        background-color: #2c974b;
        color: white;
    }
    
    /* Branch dropdown */
    .branch-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .branch-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        width: 300px;
        background-color: white;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(149,157,165,0.2);
        margin-top: 4px;
    }
    
    .branch-dropdown-header {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
        font-size: 12px;
        font-weight: 600;
    }
    
    .branch-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 8px 0;
    }
    
    .branch-item {
        padding: 8px 16px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    .branch-item:hover {
        background-color: var(--gh-bg-color);
    }
    
    .branch-item.active {
        background-color: #0366d611;
    }
    
    .branch-item i {
        margin-right: 8px;
        color: var(--gh-secondary-text);
    }
    
    .branch-name {
        flex-grow: 1;
        font-size: 14px;
    }
    
    .dropdown-toggle::after {
        display: inline-block;
        margin-left: 6px;
        vertical-align: middle;
        content: "";
        border-top: 4px solid;
        border-right: 4px solid transparent;
        border-bottom: 0;
        border-left: 4px solid transparent;
    }
    
    .branch-search {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
    }
    
    .branch-search input {
        width: 100%;
        padding: 5px 12px;
        font-size: 14px;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
    }
    
    /* GitHub code blob table */
    .code-blob {
        width: 100%;
        border-spacing: 0;
    }
    
    .code-blob tr:hover {
        background-color: var(--gh-bg-color);
    }
    
    .code-blob .line-number {
        width: 1%;
        min-width: 50px;
        padding-right: 10px;
        padding-left: 10px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 20px;
        color: var(--gh-secondary-text);
        text-align: right;
        white-space: nowrap;
        vertical-align: top;
        cursor: pointer;
        user-select: none;
    }
    
    .code-blob .line-content {
        padding-left: 10px;
        padding-right: 10px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 20px;
        white-space: pre;
        vertical-align: top;
    }
    
    /* Utility classes */
    .text-small {
        font-size: 12px !important;
    }
    
    .text-gray {
        color: var(--gh-secondary-text) !important;
    }
    
    .d-flex {
        display: flex !important;
    }
    
    .align-items-center {
        align-items: center !important;
    }
    
    /* Modal */
    .github-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .github-modal-content {
        position: relative;
        margin: 5% auto;
        width: 80%;
        max-width: 900px;
        background-color: #fff;
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(149,157,165,0.2);
    }
    
    .github-modal-header {
        padding: 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .github-modal-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }
    
    .github-modal-close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    
    .github-modal-body {
        padding: 16px;
        max-height: 70vh;
        overflow-y: auto;
    }

    #currentPath a {
    color: var(--gh-link-color);
    text-decoration: none;
    }

    #currentPath a:hover {
        text-decoration: underline;
    }

    #currentPath span {
        color: var(--gh-text-color);
    }
    
    /* For mobile responsiveness */
    @media (max-width: 768px) {
        .commit-msg {
            display: none;
        }
        
        .code-header-actions {
            display: none;
        }
        
        .repo-stats {
            flex-wrap: wrap;
        }
    /* Commit item styles */
.commit-item {
    transition: all 0.2s ease;
}

.commit-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.commit-header {
    border-radius: 6px;
    background-color: var(--gh-bg);
    border: 1px solid var(--gh-border);
}

.commit-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--gh-text-color);
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 80%;
}

.commit-meta {
    font-size: 13px;
    color: var(--gh-gray);
}

.view-details-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Commits container styles */
#commitsList {
    padding: 16px;
    background-color: #fff;
    border-radius: 0 0 6px 6px;
}

/* Commit details section (for future expansion) */
.commit-details {
    margin-top: 16px;
    padding: 16px;
    background-color: #fff;
    border: 1px solid var(--gh-border);
    border-radius: 6px;
}

.commit-file-changes {
    margin-top: 16px;
}

.file-change-item {
    padding: 8px 12px;
    border: 1px solid var(--gh-border);
    border-radius: 4px;
    margin-bottom: 8px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 13px;
}

.file-change-added {
    background-color: #e6ffec;
    border-color: #b4e2c0;
}

.file-change-modified {
    background-color: #f1f8ff;
    border-color: #c8e1ff;
}

.file-change-deleted {
    background-color: #ffebe9;
    border-color: #e9aeaa;
}
/* Add these styles to match your application's design */
.language-stats-container {
  margin-bottom: 20px;
  padding: 0 10px;
}
.languages-container {
  margin-top: 24px;
  margin-bottom: 24px;
  padding: 16px;
  background-color: white;
  border: 1px solid var(--gh-border-color);
  border-radius: 6px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--gh-text-color);
}

.language-bar-container {
  width: 100%;
  height: 10px;
  border-radius: 5px;
  overflow: hidden;
  margin-bottom: 16px;
}

.language-bars {
  display: flex;
  height: 100%;
  width: 100%;
}

.language-bar {
  height: 100%;
  transition: width 0.3s ease;
}

.language-bar-loading {
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, #eee, #f5f5f5, #eee);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0 }
  100% { background-position: -200% 0 }
}

.language-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.language-item {
  display: flex;
  align-items: center;
  font-size: 12px;
  margin-right: 16px;
}

.language-color {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 6px;
}

.language-name {
  font-weight: 600;
  margin-right: 4px;
}

.language-percentage {
  color: var(--gh-secondary-text);
}

.language-stats {
  background-color: #fff;
  border: 1px solid #e1e4e8;
  border-radius: 6px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.language-stats h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #24292e;
}

.language-bars {
  display: flex;
  height: 10px;
  width: 100%;
  margin-bottom: 16px;
  border-radius: 5px;
  overflow: hidden;
}

.language-bar {
  height: 100%;
  transition: width 0.3s ease;
}

.language-details {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.language-item {
  display: flex;
  align-items: center;
  font-size: 12px;
  margin-bottom: 8px;
}

.language-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 6px;
}

.language-name {
  margin-right: 4px;
  font-weight: 500;
}

.language-percentage {
  color: #586069;
}

.skeleton-bar {
  width: 100%;
  height: 10px;
  background: linear-gradient(90deg, #eee, #f5f5f5, #eee);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 5px;
}

@keyframes loading {
  0% { background-position: 200% 0 }
  100% { background-position: -200% 0 }
}

/* For positioning on the right side (if needed) */
@media (min-width: 992px) {
  .project-layout {
    display: flex;
    gap: 20px;
  }
  
  .main-content {
    flex: 3;
  }
  
  .sidebar-content {
    flex: 1;
    min-width: 250px;
    max-width: 300px;
  }

    /* Languages section styling */
    .languages-section {
    background-color: #0d1117;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
    color: #c9d1d9;
  }

  .languages-section h4 {
    font-size: 16px;
    margin-bottom: 10px;
    font-weight: 600;
  }

  /* Language bar container */
  .language-bar-container {
    display: flex;
    height: 8px;
    width: 100%;
    margin-bottom: 10px;
    border-radius: 4px;
    overflow: hidden;
  }

  /* Individual language bars */
  .lang-bar {
    height: 100%;
    display: inline-block;
  }

  /* Language list styling */
  .language-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }

  .lang-item {
    display: flex;
    align-items: center;
    font-size: 12px;
  }

  /* Colored dot for each language */
  .lang-color {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
  }

  .lang-name {
    margin-right: 5px;
  }

  .lang-percent {
    color: #8b949e;
  }

  .loading-placeholder {
    height: 8px;
    width: 100%;
    background: linear-gradient(90deg, #1f2937, #374151, #1f2937);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
  }

  @keyframes loading {
    0% { background-position: 200% 0 }
    100% { background-position: -200% 0 }
  }
}
    }
</style>
<script>
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
    }
    return Math.abs(hash).toString(16);
}

// Also need to add the escapeHtml function that's used in displayCommits
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
// Check authentication
const token = localStorage.getItem('jwt_token');
if (!token) {
    window.location.href = '/login.html';
}

// Global variables
let currentProject = null;
let projectFiles = [];
let projectBranches = [];
let currentBranch = 'main';
let currentPath = '';

// DOM Elements
const branchButton = document.getElementById('branchButton');
const branchDropdown = document.getElementById('branchDropdown');
const branchList = document.getElementById('branchList');
const branchSearchInput = document.getElementById('branchSearchInput');
const fullScreenModal = document.getElementById('fullScreenModal');
const modalClose = document.querySelector('.github-modal-close');

// Get project ID from URL
const urlParams = new URLSearchParams(window.location.search);
const projectId = urlParams.get('id');

if (!projectId) {
    alert('Project ID is missing');
    window.location.href = '/dashboard.html';
}

// Functions
function logout() {
    localStorage.removeItem('jwt_token');
    window.location.href = '/login.html';
}

// Initialize
async function initialize() {
    await loadUserInfo();
    await loadProjectDetails();
    await loadProjectFiles();
    await loadProjectBranches();
    loadLanguageStats();
    setupEventListeners();
    updateStarButton();
}

// Load user info
async function loadUserInfo() {
    try {
        const response = await fetch('/api/auth/user', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                document.getElementById('userInfo').textContent = `Welcome, ${result.data.username}`;
            } else {
                document.getElementById('userInfo').textContent = 'Welcome';
            }
        } else {
            console.error('Failed to load user info');
            document.getElementById('userInfo').textContent = 'Welcome';
        }
    } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('userInfo').textContent = 'Welcome';
    }
}

document.addEventListener('DOMContentLoaded', function() {
  loadLanguageStats();
});

// Load project details
async function loadProjectDetails() {
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    currentProject = result.data;
                    
                    // Update page elements
                    document.title = `${currentProject.name} - Code Sharing Platform`;
                    document.getElementById('projectTitle').textContent = currentProject.name;
                    document.getElementById('projectNameBreadcrumb').textContent = currentProject.name;
                    document.getElementById('projectNameBreadcrumb').innerHTML = `<a href="#">${currentProject.name}</a>`;
                    document.getElementById('projectDescription').textContent = currentProject.description || 'No description provided';
                    document.getElementById('projectOwner').textContent = currentProject.owner.username;
                    document.getElementById('projectCreated').textContent = new Date(currentProject.createdAt).toLocaleDateString();
                    
                    // Set visibility status and update UI
                    const isPublic = currentProject.isPublic !== undefined ? currentProject.isPublic : currentProject.public;
                    document.getElementById('projectVisibility').textContent = isPublic ? 'Public' : 'Private';
                    updateVisibilityDisplay(isPublic);
                    
                    /* Rest of your existing code */
                } else {
                    alert('Failed to load project details');
                    window.location.href = '/dashboard.html';
                }
            } else {
                alert('Failed to load project details');
                window.location.href = '/dashboard.html';
            }
        } catch (error) {
            console.error('Error loading project details:', error);
            alert('Failed to load project details');
            window.location.href = '/dashboard.html';
        }
    }

// Load project files
async function loadProjectFiles() {
    try {
        const response = await fetch(`/api/files/project/${projectId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                projectFiles = result.data;
                document.getElementById('fileCount').textContent = projectFiles.length;
                displayFiles(buildFileTree(projectFiles));
            } else {
                document.getElementById('fileList').innerHTML = '<li class="file-item"><span class="text-muted">No files yet. Add some!</span></li>';
            }
        } else {
            document.getElementById('fileList').innerHTML = '<li class="file-item"><div class="alert alert-danger">Failed to load files</div></li>';
        }
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('fileList').innerHTML = '<li class="file-item"><div class="alert alert-danger">Failed to load files</div></li>';
    }
}
//Load All Branches
async function loadProjectBranches() {
    try {
        console.log("Loading project branches...");
        const response = await fetch(`/api/branches/project/${projectId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log("Branches API response:", result);
            
            if (result.success && result.data) {
                projectBranches = result.data;
                document.getElementById('branchCount').textContent = projectBranches.length;
                
                // Find default branch
                const defaultBranch = projectBranches.find(branch => branch.default);
                if (defaultBranch) {
                    currentBranch = defaultBranch.name;
                    console.log("Default branch found:", currentBranch);
                    document.getElementById('currentBranch').textContent = currentBranch;
                } else if (projectBranches.length > 0) {
                    // If no default branch, use the first one
                    currentBranch = projectBranches[0].name;
                    console.log("No default branch, using first branch:", currentBranch);
                    document.getElementById('currentBranch').textContent = currentBranch;
                } else {
                    // No branches found, create master branch
                    console.log("No branches found, displaying default branch name");
                    currentBranch = "master"; // Default to master if no branches
                    document.getElementById('currentBranch').textContent = currentBranch;
                }
                
                // Populate branch dropdown
                populateBranchDropdown();
            } else {
                console.log("No branches returned from API");
                // Handle the case where no branches exist yet
                currentBranch = "master"; // Default to master if no branches
                document.getElementById('currentBranch').textContent = currentBranch;
                document.getElementById('branchCount').textContent = "0";
            }
        } else {
            console.error('Failed to load branches, status:', response.status);
            // Show error message in console
            const errorText = await response.text();
            console.error('Error response:', errorText);
        }
    } catch (error) {
        console.error('Error loading branches:', error);
    }
}

// Populate branch dropdown
function populateBranchDropdown() {
    branchList.innerHTML = '';
    
    projectBranches.forEach(branch => {
        const branchItem = document.createElement('div');
        branchItem.className = `branch-item ${branch.name === currentBranch ? 'active' : ''}`;
        branchItem.dataset.branch = branch.name;
        
        branchItem.innerHTML = `
            <i class="fa fa-code-branch"></i>
            <span class="branch-name">${branch.name}</span>
            ${branch.default ? '<span class="badge bg-success text-small">default</span>' : ''}
        `;
        
        branchItem.addEventListener('click', function() {
            currentBranch = this.dataset.branch;
            document.getElementById('currentBranch').textContent = currentBranch;
            branchDropdown.style.display = 'none';
            loadProjectFiles(); // Reload files for the new branch
        });
        
        branchList.appendChild(branchItem);
    });
}

// Build file tree from flat list
function buildFileTree(files) {
    const root = { type: 'dir', name: '', path: '', children: {} };
    
    files.forEach(file => {
        let path = file.path;
        let parts = path.split('/');
        
        let currentDir = root;
        let currentPath = '';
        
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!part) continue;
            
            currentPath = currentPath ? `${currentPath}/${part}` : part;
            
            if (!currentDir.children[part]) {
                currentDir.children[part] = {
                    type: 'dir',
                    name: part,
                    path: currentPath,
                    children: {}
                };
            }
            
            currentDir = currentDir.children[part];
        }
        
        const fileName = parts[parts.length - 1];
        if (fileName) {
            currentDir.children[fileName] = {
                type: 'file',
                name: fileName,
                path: file.path,
                id: file.id,
                content: file.content
            };
        }
    });
    
    return root;
}

// Display files
function displayFiles(root) {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    // Add parent directory link if we're in a subdirectory
    if (currentPath !== '') {
        const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
        const parentItem = document.createElement('li');
        parentItem.className = 'dir-item';
        parentItem.innerHTML = `
            <i class="fa fa-folder file-icon file-dir-icon"></i>
            <a href="#" class="dir-name" data-path="${parentPath}">..</a>
        `;
        parentItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(parentPath);
        });
        fileList.appendChild(parentItem);
    }
    
    // Find current directory based on path
    let currentDir = root;
    if (currentPath) {
        const pathParts = currentPath.split('/');
        for (const part of pathParts) {
            if (part && currentDir.children && currentDir.children[part]) {
                currentDir = currentDir.children[part];
            }
        }
    }
    
    // Display directories first
    const dirEntries = [];
    const fileEntries = [];
    
    for (const name in currentDir.children) {
        const entry = currentDir.children[name];
        if (entry.type === 'dir') {
            dirEntries.push(entry);
        } else {
            fileEntries.push(entry);
        }
    }
    
    // Sort entries by name
    dirEntries.sort((a, b) => a.name.localeCompare(b.name));
    fileEntries.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add directories
    dirEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'dir-item';
        listItem.innerHTML = `
            <i class="fa fa-folder file-icon file-dir-icon"></i>
            <a href="#" class="dir-name" data-path="${entry.path}">${entry.name}</a>
        `;
        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(entry.path);
        });
        fileList.appendChild(listItem);
    });
    
    // Add files
    fileEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'file-item';
        
        // Determine file icon based on extension
        let fileIconClass = 'fa-file';
        const ext = entry.name.split('.').pop().toLowerCase();
        if (['java', 'js', 'ts', 'py', 'rb', 'php', 'c', 'cpp', 'h', 'cs'].includes(ext)) {
            fileIconClass = 'fa-file-code';
        } else if (['md', 'txt', 'log'].includes(ext)) {
            fileIconClass = 'fa-file-alt';
        } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
            fileIconClass = 'fa-file-image';
        } else if (['pdf'].includes(ext)) {
            fileIconClass = 'fa-file-pdf';
        } else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) {
            fileIconClass = 'fa-file-archive';
        } else if (['doc', 'docx'].includes(ext)) {
            fileIconClass = 'fa-file-word';
        } else if (['xls', 'xlsx'].includes(ext)) {
            fileIconClass = 'fa-file-excel';
        } else if (['ppt', 'pptx'].includes(ext)) {
            fileIconClass = 'fa-file-powerpoint';
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
            fileIconClass = 'fa-file-audio';
        } else if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) {
            fileIconClass = 'fa-file-video';
        }
        
        listItem.innerHTML = `
            <i class="fa ${fileIconClass} file-icon"></i>
            <a href="#" class="file-name" data-file-id="${entry.id}">${entry.name}</a>
            <span class="commit-msg">Updated recently</span>
        `;
        
        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            loadFile(entry.id);
        });
        
        fileList.appendChild(listItem);
    });
    
    // Update current path display with clickable breadcrumbs
    document.getElementById('currentPath').textContent = currentPath || '.';
    updateBreadcrumbPath(currentPath);
}

function updateBreadcrumbPath(path) {
    const currentPathElement = document.getElementById('currentPath');
    
    // Clear the current path display
    currentPathElement.innerHTML = '';
    
    if (!path || path === '') {
        // If at root, just display a dot
        currentPathElement.textContent = '.';
        return;
    }
    
    // Split the path into segments
    const segments = path.split('/');
    let currentPath = '';
    
    // Create clickable elements for each segment
    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];
        if (!segment) continue; // Skip empty segments
        
        // Update current path
        currentPath += (currentPath ? '/' : '') + segment;
        
        // Create the segment element - last segment is not clickable
        if (i === segments.length - 1) {
            // Last segment - not clickable
            const span = document.createElement('span');
            span.textContent = segment;
            currentPathElement.appendChild(span);
        } else {
            // Intermediate segment - clickable
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = segment;
            link.dataset.path = currentPath;
            
            // Add click event handler
            link.addEventListener('click', function(e) {
                e.preventDefault();
                navigateToPath(this.dataset.path);
            });
            
            currentPathElement.appendChild(link);
            
            // Add separator
            const separator = document.createElement('span');
            separator.textContent = ' / ';
            currentPathElement.appendChild(separator);
        }
    }
}

// Navigate to directory path
function navigateToPath(path) {
    currentPath = path;
    // Re-display files for the new path
    displayFiles(buildFileTree(projectFiles));
    // Update the breadcrumb path
    updateBreadcrumbPath(path);
    // Hide code display when navigating
    document.getElementById('codeContainer').style.display = 'none';
}

// Load file content
async function loadFile(fileId) {
    try {
        const response = await fetch(`/api/files/${fileId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                const file = result.data;
                displayFileContent(file);
            } else {
                alert('Failed to load file content');
            }
        } else {
            alert('Failed to load file content');
        }
    } catch (error) {
        console.error('Error loading file content:', error);
        alert('Failed to load file content');
    }
}

// Display file content
function displayFileContent(file) {
    // Update file name in header
    document.getElementById('currentFileName').textContent = file.name;
    
    // Get the code container and make it visible
    const codeContainer = document.getElementById('codeContainer');
    codeContainer.style.display = 'block';
    
    // Build the code table with line numbers
    const codeTable = document.getElementById('codeTable');
    codeTable.innerHTML = '';
    
    // Split content by lines and add line numbers
    const lines = file.content ? file.content.split('\n') : ['No content'];
    
    lines.forEach((line, index) => {
        const row = document.createElement('tr');
        
        // Line number cell
        const lineNumberCell = document.createElement('td');
        lineNumberCell.className = 'line-number';
        lineNumberCell.textContent = index + 1;
        lineNumberCell.dataset.lineNumber = index + 1;
        row.appendChild(lineNumberCell);
        
        // Line content cell
        const lineContentCell = document.createElement('td');
        lineContentCell.className = 'line-content';
        lineContentCell.textContent = line;
        row.appendChild(lineContentCell);
        
        codeTable.appendChild(row);
    });
    
    // Set up the raw button link
    document.getElementById('rawButton').href = `/api/files/${file.id}/raw`;
    
    // Set up download button
    document.getElementById('downloadButton').href = `/api/files/${file.id}/raw`;
    document.getElementById('downloadButton').download = file.name;
    
    // Scroll to top of page
    window.scrollTo(0, 0);
    
    // Update modal data for full screen view
    document.getElementById('modalFileName').textContent = file.name;
    document.getElementById('modalCode').textContent = file.content || 'No content';
    
    // Apply syntax highlighting based on file extension
    applyCodeHighlighting(file.name);
}

// Apply syntax highlighting
function applyCodeHighlighting(fileName) {
    // Get file extension
    const ext = fileName.split('.').pop().toLowerCase();
    
    // Map of extensions to highlight.js language classes
    const languageMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'html': 'html',
        'xml': 'xml',
        'css': 'css',
        'scss': 'scss',
        'sass': 'scss',
        'less': 'less',
        'java': 'java',
        'py': 'python',
        'rb': 'ruby',
        'php': 'php',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'cpp',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'swift': 'swift',
        'kt': 'kotlin',
        'md': 'markdown',
        'json': 'json',
        'yml': 'yaml',
        'yaml': 'yaml',
        'sql': 'sql',
        'sh': 'bash',
        'bat': 'batch',
        'ps1': 'powershell',
        'dockerfile': 'dockerfile',
        'properties': 'properties',
        'gradle': 'gradle'
    };
    
    // Set class on modal code element for highlighting
    const language = languageMap[ext] || '';
    if (language) {
        const modalCode = document.getElementById('modalCode');
        modalCode.className = `language-${language}`;
        
        // Initialize highlight.js
        if (window.hljs) {
            window.hljs.highlightElement(modalCode);
        }
    }
}
        // Add these functions to the project.html JavaScript:

        // Toggle star status
        function toggleStar() {
            const projectId = parseInt(urlParams.get('id'));
            
            // Get current starred repos from localStorage
            let starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
            
            const isStarred = starredRepoIds.includes(projectId);
            
            if (isStarred) {
                // Remove from starred
                starredRepoIds = starredRepoIds.filter(id => id !== projectId);
            } else {
                // Add to starred
                starredRepoIds.push(projectId);
            }
            
            // Update localStorage
            localStorage.setItem('starredRepos', JSON.stringify(starredRepoIds));
            
            // Update UI
            const starButton = document.querySelector('.gh-btn:nth-child(1)');
            if (starButton) {
                starButton.innerHTML = isStarred ? 
                    '<i class="fa fa-star-o"></i> Star' : 
                    '<i class="fa fa-star"></i> Unstar';
            }
        }

        // Fork repository
        function forkRepository() {
            const projectId = parseInt(urlParams.get('id'));
            alert('Repository forked successfully! (This is a simulation)');
        }

        // Update event listeners in setupEventListeners function:
        document.querySelector('.gh-btn:nth-child(1)').addEventListener('click', toggleStar);
        document.querySelector('.gh-btn:nth-child(2)').addEventListener('click', forkRepository);

        // Add this to the initialize function:
        // Check if repository is already starred and update UI
        function updateStarButton() {
            const projectId = parseInt(urlParams.get('id'));
            const starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
            const isStarred = starredRepoIds.includes(projectId);
            
            const starButton = document.querySelector('.gh-btn:nth-child(1)');
            if (starButton) {
                starButton.innerHTML = isStarred ? 
                    '<i class="fa fa-star"></i> Unstar' : 
                    '<i class="fa fa-star-o"></i> Star';
            }
        }

        function setupEventListeners() {
    // Branch dropdown toggle
    branchButton.addEventListener('click', function() {
        if (branchDropdown.style.display === 'block') {
            branchDropdown.style.display = 'none';
        } else {
            branchDropdown.style.display = 'block';
            branchSearchInput.focus();
        }
    });
    
    // Branch search
    branchSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const branchItems = branchList.querySelectorAll('.branch-item');
        
        branchItems.forEach(item => {
            const branchName = item.querySelector('.branch-name').textContent.toLowerCase();
            if (branchName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!branchButton.contains(event.target) && !branchDropdown.contains(event.target)) {
            branchDropdown.style.display = 'none';
        }
    });

    // Visibility toggle event listeners
    document.getElementById('makePublicOption').addEventListener('click', function(e) {
        e.preventDefault();
        toggleProjectVisibility(true);
    });
    
    document.getElementById('makePrivateOption').addEventListener('click', function(e) {
        e.preventDefault();
        toggleProjectVisibility(false);
    });

    // Copy button
    document.getElementById('copyButton').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Get content from lines
        const lineContents = document.querySelectorAll('.line-content');
        let content = '';
        lineContents.forEach(line => {
            content += line.textContent + '\n';
        });
        
        // Copy to clipboard
        navigator.clipboard.writeText(content).then(function() {
            alert('Content copied to clipboard!');
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
        });
    });
    
    // Full screen button
    document.getElementById('fullScreenButton').addEventListener('click', function(e) {
        e.preventDefault();
        fullScreenModal.style.display = 'block';
        
        // Apply syntax highlighting
        if (window.hljs) {
            window.hljs.highlightElement(document.getElementById('modalCode'));
        }
    });
    
    // Close modal
    modalClose.addEventListener('click', function() {
        fullScreenModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === fullScreenModal) {
            fullScreenModal.style.display = 'none';
        }
    });
    
    // Set up commit tab listener
    setupCommitTabListener();
}

function setupCommitTabListener() {
    const commitsTab = document.getElementById('commitsTab');
    if (commitsTab) {
        commitsTab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            commitsTab.classList.add('active');
            
            // Hide other content sections
            document.querySelector('.file-explorer').style.display = 'none';
            document.getElementById('codeContainer').style.display = 'none';
            document.getElementById('pullRequestsContainer').style.display = 'none';
            
            // Show commits container
            document.getElementById('commitsContainer').style.display = 'block';
            
            // Load commits
            loadCommitHistory();
        });
    }
}
document.head.insertAdjacentHTML('beforeend', `
        <style>
            #toast-container {
                z-index: 1050;
            }
            
            .toast {
                min-width: 250px;
                margin-bottom: 10px;
            }
            
            .toast-success {
                background-color: #d4edda;
                border-color: #c3e6cb;
            }
            
            .toast-success .toast-header {
                background-color: #c3e6cb;
                color: #155724;
            }
            
            .toast-error {
                background-color: #f8d7da;
                border-color: #f5c6cb;
            }
            
            .toast-error .toast-header {
                background-color: #f5c6cb;
                color: #721c24;
            }
        </style>
    `);
 // Toggle project visibility
 async function toggleProjectVisibility(makePublic) {
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    isPublic: makePublic
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Update UI to reflect the new visibility status
                updateVisibilityDisplay(makePublic);
                
                // Show toast notification
                const message = makePublic ? 
                    'Repository is now public - anyone can see it' : 
                    'Repository is now private - only you and collaborators can see it';
                showToast(message, 'success');
            } else {
                throw new Error(result.message || 'Failed to update project visibility');
            }
        } catch (error) {
            console.error('Error updating project visibility:', error);
            showToast('Failed to update repository visibility', 'error');
        }
    }

    // Update visibility display based on state
    function updateVisibilityDisplay(isPublic) {
        // Update button icon and text
        const visibilityBtnIcon = document.getElementById('visibilityBtnIcon');
        const visibilityBtnText = document.getElementById('visibilityBtnText');
        
        // Update project stats indicator
        const projectVisibility = document.getElementById('projectVisibility');
        
        // Update dropdown options
        const makePublicOption = document.getElementById('makePublicOption');
        const makePrivateOption = document.getElementById('makePrivateOption');
        
        if (isPublic) {
            visibilityBtnIcon.className = 'fa fa-globe';
            visibilityBtnText.textContent = 'Public';
            projectVisibility.textContent = 'Public';
            makePublicOption.style.display = 'none';
            makePrivateOption.style.display = 'block';
        } else {
            visibilityBtnIcon.className = 'fa fa-lock';
            visibilityBtnText.textContent = 'Private';
            projectVisibility.textContent = 'Private';
            makePublicOption.style.display = 'block';
            makePrivateOption.style.display = 'none';
        }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        // Simple implementation - you can enhance this with a proper toast library
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }


// Add to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Pull Request tab handling
    const filesTab = document.getElementById('filesTab');
    const pullRequestsTab = document.getElementById('pullRequestsTab');
    const commitsTab = document.getElementById('commitsTab');
    const issuesTab = document.getElementById('issuesTab');
    
    const fileExplorer = document.querySelector('.file-explorer');
    const codeContainer = document.getElementById('codeContainer');
    const pullRequestsContainer = document.getElementById('pullRequestsContainer');
    
    if (filesTab && pullRequestsTab) {
        filesTab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            filesTab.classList.add('active');
            
            // Show files, hide pull requests
            fileExplorer.style.display = 'block';
            if (codeContainer) codeContainer.style.display = 'none';
            pullRequestsContainer.style.display = 'none';
        });
        
        pullRequestsTab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            pullRequestsTab.classList.add('active');
            
            // Hide files, show pull requests
            fileExplorer.style.display = 'none';
            if (codeContainer) codeContainer.style.display = 'none';
            pullRequestsContainer.style.display = 'block';
            
            // Load pull requests
            loadPullRequests('OPEN');
        });
    }
    
    // Function to load pull requests
    function loadPullRequests(status = 'OPEN') {
        const projectId = new URLSearchParams(window.location.search).get('id');
        if (!projectId) return;
        
        const pullRequestsList = document.getElementById('pullRequestsList');
        pullRequestsList.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        fetch(`/api/pull-requests/project/${projectId}?status=${status}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                displayPullRequests(data.data);
            } else {
                pullRequestsList.innerHTML = `
                    <div class="list-group-item text-center py-4">
                        <p class="mb-0 text-muted">No pull requests found</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading pull requests:', error);
            pullRequestsList.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <p class="mb-0 text-danger">Failed to load pull requests</p>
                </div>
            `;
        });
    }
    
    // Function to display pull requests
    function displayPullRequests(pullRequests) {
        const pullRequestsList = document.getElementById('pullRequestsList');
        
        if (pullRequests.length === 0) {
            pullRequestsList.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <p class="mb-0 text-muted">No pull requests found</p>
                </div>
            `;
            return;
        }
        
        pullRequestsList.innerHTML = '';
        
        pullRequests.forEach(pr => {
            const statusClass = 
                pr.status === 'OPEN' ? 'bg-success' : 
                pr.status === 'MERGED' ? 'bg-info' : 'bg-secondary';
            
            const listItem = document.createElement('a');
            listItem.href = `/pull-request.html?id=${pr.id}`;
            listItem.className = 'list-group-item list-group-item-action';
            
            listItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <h5 class="mb-1">${pr.title}</h5>
                    <span class="badge ${statusClass}">${pr.status}</span>
                </div>
                <p class="mb-1">${pr.description || 'No description provided'}</p>
                <small class="text-muted">
                    #${pr.id} opened by ${pr.author.username} 
                    ${timeAgo(new Date(pr.createdAt))}
                </small>
            `;
            
            pullRequestsList.appendChild(listItem);
        });
    }
    
    // Status filter for pull requests
    document.querySelectorAll('.card-header-tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            document.querySelectorAll('.card-header-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            this.classList.add('active');
            
            // Load pull requests with selected status
            const status = this.getAttribute('data-pr-status');
            loadPullRequests(status);
        });
    });
    
    // New Pull Request button
    const newPRButton = document.getElementById('newPRButton');
    if (newPRButton) {
        newPRButton.addEventListener('click', function() {
            // Navigate to new PR page or show modal
            const projectId = new URLSearchParams(window.location.search).get('id');
            window.location.href = `/pull-request.html?projectId=${projectId}`;
        });
    }
    
    // Helper function to format time ago
    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        let interval = Math.floor(seconds / 31536000);
        if (interval >= 1) {
            return interval + " year" + (interval === 1 ? "" : "s") + " ago";
        }
        
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) {
            return interval + " month" + (interval === 1 ? "" : "s") + " ago";
        }
        
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) {
            return interval + " day" + (interval === 1 ? "" : "s") + " ago";
        }
        
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) {
            return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
        }
        
        interval = Math.floor(seconds / 60);
        if (interval >= 1) {
            return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
        }
        
        return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s") + " ago";
    }
});

/**
 * Load commit history for the current project and branch
 */
 async function loadCommitHistory() {
    try {
        // Show loading indicator
        document.getElementById('commitsList').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        console.log("Loading commit history...");
        console.log("Available branches:", projectBranches);
        console.log("Current branch name:", currentBranch);
        
        // Get branch ID from projectBranches array
        let branchId = null;
        if (projectBranches && projectBranches.length > 0) {
            const branch = projectBranches.find(b => b.name === currentBranch);
            if (branch) {
                branchId = branch.id;
                console.log("Found branch ID:", branchId);
            } else {
                // If we can't find the branch by name, use the first branch
                branchId = projectBranches[0].id;
                console.log("Using first branch ID:", branchId);
            }
        } else {
            console.log("No branches found in projectBranches array");
            // Direct API call to get project's branches
            try {
                const branchResponse = await fetch(`/api/branches/project/${projectId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (branchResponse.ok) {
                    const branchResult = await branchResponse.json();
                    console.log("Direct branch API response:", branchResult);
                    
                    if (branchResult.success && branchResult.data && branchResult.data.length > 0) {
                        branchId = branchResult.data[0].id;
                        console.log("Found branch ID from direct API call:", branchId);
                    }
                }
            } catch (e) {
                console.error("Error fetching branches directly:", e);
            }
        }

        // If we still don't have a branch ID, show an error
        if (!branchId) {
            document.getElementById('commitsList').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    No branches found for this project. You need to create a branch first.
                </div>
            `;
            return;
        }
        
        // Now that we have a branch ID, get the commits
        const response = await fetch(`/api/version-control/commit-history?branchId=${branchId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log("Commit history response:", result);
            
            if (result.success && result.data && result.data.length > 0) {
                displayCommits(result.data);
            } else {
                document.getElementById('commitsList').innerHTML = `
                    <div class="alert alert-warning">
                        No commits found for this branch.
                    </div>
                `;
            }
        } else {
            console.error("Error fetching commits:", response.status);
            const errorText = await response.text();
            console.error("Error response:", errorText);
            throw new Error(`Failed to load commits: ${response.status}`);
        }
    } catch (error) {
        console.error('Error loading commits:', error);
        document.getElementById('commitsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fa fa-exclamation-triangle me-2"></i>
                Failed to load commits: ${error.message}
            </div>
        `;
    }
}
/**
 * Display commits in the commits tab
 */
 function displayCommits(commits) {
    const commitsList = document.getElementById('commitsList');
    
    // If no commits, show a message
    if (!commits || commits.length === 0) {
        commitsList.innerHTML = `
            <div class="alert alert-info">
                <i class="fa fa-info-circle me-2"></i>
                No commits found for this branch.
            </div>
        `;
        return;
    }

    // Update the commits count badge
    if (document.getElementById('commitsCount')) {
        document.getElementById('commitsCount').textContent = commits.length;
    }
    
    // Clear the list
    commitsList.innerHTML = '';
    
    // Add each commit to the list
    commits.forEach(commit => {
        // Format date nicely
        const commitDate = new Date(commit.createdAt);
        const formattedDate = commitDate.toLocaleDateString() + ' ' + 
            commitDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Check if author exists and has a username
        let authorUsername = "Unknown";
        if (commit.author && commit.author.username) {
            authorUsername = commit.author.username;
        }
        
        // Create the commit item
        const commitItem = document.createElement('div');
        commitItem.className = 'commit-item mb-3';
        commitItem.innerHTML = `
            <div class="commit-header d-flex align-items-center p-3 bg-light border rounded">
                <img src="https://www.gravatar.com/avatar/${hashString(authorUsername)}?d=mp&f=y" 
                    alt="${authorUsername}" class="avatar-img-medium me-3">
                <div class="flex-grow-1">
                    <h5 class="commit-title mb-1">${escapeHtml(commit.message || "No message")}</h5>
                    <div class="commit-meta">
                        <span class="me-3">
                            <strong>${escapeHtml(authorUsername)}</strong> committed on ${formattedDate}
                        </span>
                        <span class="text-muted">
                            <i class="fa fa-code-commit me-1"></i>
                            Commit ${commit.id.toString()}
                        </span>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary view-details-btn" 
                    data-commit-id="${commit.id}" onclick="viewCommitDetails(${commit.id})">
                    <i class="fa fa-eye me-1"></i> View
                </button>
            </div>
        `;
        
        commitsList.appendChild(commitItem);
        
    });
    setupBatchCommitViewing();
}

/**
 * View details of a batch of commits
 * Redirects to commit-details.html with comma-separated commit IDs
 */
 function viewCommitBatch(commitIds) {
    if (!Array.isArray(commitIds) || commitIds.length === 0) {
        return;
    }
    
    // Navigate to commit details page with batch commits
    window.location.href = `/commit-details.html?commits=${commitIds.join(',')}&projectId=${projectId}`;
}

/**
 * Enable batch commit viewing functionality
 */
 function setupBatchCommitViewing() {
    // Find consecutive commits with the same timestamp and author
    const commitGroups = [];
    let currentGroup = [];
    
    // Get all commits from the DOM
    const commitElements = document.querySelectorAll('.commit-item');
    
    commitElements.forEach((element, index) => {
        const commitId = element.getAttribute('data-commit-id');
        const commitAuthor = element.getAttribute('data-author');
        const commitTimestamp = element.getAttribute('data-timestamp');
        
        if (index === 0) {
            // Start first group
            currentGroup.push(commitId);
        } else {
            // Check if this commit belongs to the current group
            const prevElement = commitElements[index - 1];
            const prevAuthor = prevElement.getAttribute('data-author');
            const prevTimestamp = prevElement.getAttribute('data-timestamp');
            
            if (prevAuthor === commitAuthor && prevTimestamp === commitTimestamp) {
                // Same author and timestamp, add to current group
                currentGroup.push(commitId);
            } else {
                // Different author or timestamp, start a new group
                if (currentGroup.length > 0) {
                    commitGroups.push([...currentGroup]);
                }
                currentGroup = [commitId];
            }
        }
    });
    
    // Add the last group if it exists
    if (currentGroup.length > 0) {
        commitGroups.push([...currentGroup]);
    }
    
    // For each group with more than one commit, add a "View as batch" button
    commitGroups.forEach(group => {
        if (group.length > 1) {
            // Find the first commit in this group
            const firstCommitElement = document.querySelector(`.commit-item[data-commit-id="${group[0]}"]`);
            
            if (firstCommitElement) {
                // Add a batch view button
                const batchBtn = document.createElement('button');
                batchBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
                batchBtn.innerHTML = `<i class="fa fa-layer-group me-1"></i> View ${group.length} commits as batch`;
                
                // Add click handler
                batchBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    viewCommitBatch(group);
                });
                
                // Find the commit actions area and append button
                const actionsArea = firstCommitElement.querySelector('.commit-actions');
                if (actionsArea) {
                    actionsArea.appendChild(batchBtn);
                }
            }
        }
    });
}

/**
 * View details of a specific commit
 */
 async function viewCommitDetails(commitId) {
    
    try {
        // Initialize the modal
        const modal = new bootstrap.Modal(document.getElementById('commitDetailsModal'));
        
        // Show the modal with loading state
        document.getElementById('commitDetailsLoading').style.display = 'block';
        document.getElementById('commitDetailsContent').style.display = 'none';
        document.getElementById('commitDetailsError').style.display = 'none';
        
        modal.show();
        
        // Fetch commit details
        const response = await fetch(`/api/version-control/commit-details?commitId=${commitId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data) {
            // Hide loading and show content
            document.getElementById('commitDetailsLoading').style.display = 'none';
            document.getElementById('commitDetailsContent').style.display = 'block';
            
            const details = result.data;
            const commit = details.commit;
            const fileChanges = details.fileChanges || {};
            
            // Update commit info
            document.getElementById('commitMessage').textContent = commit.message;
            document.getElementById('commitAuthor').textContent = commit.author ? commit.author.username : 'Unknown';
            
            // Format date
            const commitDate = new Date(commit.createdAt);
            document.getElementById('commitDate').textContent = commitDate.toLocaleString();
            
            // Set author avatar
            const authorUsername = commit.author ? commit.author.username : 'Unknown';
            document.getElementById('commitAuthorAvatar').src = 
                `https://www.gravatar.com/avatar/${hashString(authorUsername)}?d=mp&f=y`;
            
            // List changed files
            const filesList = document.getElementById('commitFilesList');
            filesList.innerHTML = '';
            
            if (Object.keys(fileChanges).length === 0) {
                filesList.innerHTML = '<div class="list-group-item text-muted">No file changes found</div>';
            } else {
                Object.keys(fileChanges).forEach(filePath => {
                    const listItem = document.createElement('a');
                    listItem.href = '#';
                    listItem.className = 'list-group-item list-group-item-action';
                    
                    // Get file icon based on extension
                    const extension = filePath.split('.').pop().toLowerCase();
                    let fileIcon = 'fa-file';
                    
                    if (['js', 'jsx', 'ts', 'tsx'].includes(extension)) {
                        fileIcon = 'fa-file-code text-warning';
                    } else if (['html', 'htm', 'xml'].includes(extension)) {
                        fileIcon = 'fa-file-code text-danger';
                    } else if (['css', 'scss', 'sass'].includes(extension)) {
                        fileIcon = 'fa-file-code text-primary';
                    } else if (['java', 'py', 'rb', 'php', 'c', 'cpp', 'cs'].includes(extension)) {
                        fileIcon = 'fa-file-code text-success';
                    } else if (['md', 'txt'].includes(extension)) {
                        fileIcon = 'fa-file-alt';
                    } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) {
                        fileIcon = 'fa-file-image';
                    }
                    
                    listItem.innerHTML = `
                        <i class="fa ${fileIcon} me-2"></i>
                        ${filePath}
                    `;
                    
                    // Click handler to show file content
                    listItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        displayFileChanges(filePath, fileChanges[filePath]);
                    });
                    
                    filesList.appendChild(listItem);
                });
                
                // Automatically display the first file
                if (Object.keys(fileChanges).length > 0) {
                    const firstFile = Object.keys(fileChanges)[0];
                    displayFileChanges(firstFile, fileChanges[firstFile]);
                }
            }
        } else {
            throw new Error(result.message || 'Failed to load commit details');
        }
    } catch (error) {
        console.error('Error viewing commit details:', error);
        document.getElementById('commitDetailsLoading').style.display = 'none';
        document.getElementById('commitDetailsError').style.display = 'block';
        document.getElementById('commitDetailsError').textContent = 'Error: ' + error.message;
    }
    window.location.href = `/commit-details.html?id=${commitId}&projectId=${projectId}`;
}
/**
 * Display file changes in the commit details modal
 */
 function displayFileChanges(filePath, content) {
    const fileChangesContent = document.getElementById('fileChangesContent');
    
    // Determine language for syntax highlighting
    const extension = filePath.split('.').pop().toLowerCase();
    let language = '';
    
    switch (extension) {
        case 'js':
            language = 'javascript';
            break;
        case 'java':
            language = 'java';
            break;
        case 'py':
            language = 'python';
            break;
        case 'rb':
            language = 'ruby';
            break;
        case 'php':
            language = 'php';
            break;
        case 'html':
        case 'htm':
            language = 'html';
            break;
        case 'css':
            language = 'css';
            break;
        case 'xml':
            language = 'xml';
            break;
        case 'json':
            language = 'json';
            break;
        case 'md':
            language = 'markdown';
            break;
        case 'sql':
            language = 'sql';
            break;
        default:
            language = 'plaintext';
    }
    
    // Create a pre>code element with appropriate classes for highlight.js
    fileChangesContent.innerHTML = `
        <div class="card">
            <div class="card-header bg-light">
                <i class="fa fa-file me-2"></i>${filePath}
            </div>
            <div class="card-body p-0">
                <pre style="margin: 0; border-radius: 0;"><code class="language-${language}">${escapeHtml(content)}</code></pre>
            </div>
        </div>
    `;
    
    // Apply syntax highlighting
    document.querySelectorAll('pre code').forEach((block) => {
        if (window.hljs) {
            window.hljs.highlightElement(block);
        }
    });
}
// Language colors mapping similar to GitHub
const languageColors = {
  'HTML': '#e34c26',
  'Java': '#b07219',
  'JavaScript': '#f1e05a',
  'TypeScript': '#2b7489',
  'CSS': '#563d7c',
  'Python': '#3572A5',
  'Ruby': '#701516',
  'PHP': '#4F5D95',
  'C': '#555555',
  'C++': '#f34b7d',
  'C#': '#178600',
  'Shell': '#89e051',
  'Batch': '#C1F12E',
  'PowerShell': '#012456',
  'Go': '#00ADD8',
  'Kotlin': '#F18E33',
  'Swift': '#ffac45',
  'Rust': '#dea584',
  'Gradle': '#02303A',
  'XML': '#0060ac',
  'JSON': '#292929',
  'Markdown': '#083fa1',
  'Text': '#cccccc',
  'YAML': '#cb171e',
  'Other': '#8b949e'
};
/**
 * Fetch and display language statistics for the current project
 */
 async function loadLanguageStats() {
  // Get container elements
  const languageBars = document.getElementById('language-bars');
  const languageList = document.getElementById('language-list');
  const loadingBar = document.getElementById('language-bar-loading');
  
  if (!languageBars || !languageList) return;
  
  try {
    // Get project ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    
    if (!projectId) {
      throw new Error('Project ID not found');
    }
    
    // Make API request to get language statistics
    const response = await fetch(`/api/projects/${projectId}/languages`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to load language statistics: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (!result.success || !result.data) {
      throw new Error('Invalid response from server');
    }
    
    const languageData = result.data;
    
    // If no languages found
    if (Object.keys(languageData).length === 0) {
      languageList.innerHTML = '<li class="text-muted">No language data available</li>';
      return;
    }
    
    // Sort languages by percentage (descending)
    const sortedLanguages = Object.entries(languageData)
      .sort((a, b) => b[1] - a[1]);
    
    // Generate the language bars
    let barsHtml = '';
    sortedLanguages.forEach(([language, percentage]) => {
      const color = languageColors[language] || '#8b949e'; // Default color for unknown languages
      barsHtml += `<div class="language-bar" 
                      style="width: ${percentage}%; background-color: ${color};" 
                      title="${language}: ${percentage.toFixed(1)}%"></div>`;
    });
    
    // Update bars and hide loading
    languageBars.innerHTML = barsHtml;
    languageBars.style.display = 'flex';
    loadingBar.style.display = 'none';
    
    // Generate the language list
    languageList.innerHTML = '';
    sortedLanguages.forEach(([language, percentage]) => {
      if (percentage >= 0.1) { // Only show languages with at least 0.1%
        const color = languageColors[language] || '#8b949e';
        const listItem = document.createElement('li');
        listItem.className = 'language-item';
        listItem.innerHTML = `
          <span class="language-color" style="background-color: ${color};"></span>
          <span class="language-name">${language}</span>
          <span class="language-percentage">${percentage.toFixed(1)}%</span>
        `;
        languageList.appendChild(listItem);
      }
    });
    
  } catch (error) {
    console.error('Error loading language statistics:', error);
    languageList.innerHTML = '<li class="text-muted">Unable to load language statistics</li>';
    
    // Hide loading indicator
    if (loadingBar) loadingBar.style.display = 'none';
  }
}
function generateLanguageStats(languageData) {
  // If no languages found
  if (Object.keys(languageData).length === 0) {
    return `
      <div class="languages-section">
        <h4>Languages</h4>
        <div class="text-muted">No language data available</div>
      </div>
    `;
  }

  // Sort languages by percentage (descending)
  const sortedLanguages = Object.entries(languageData)
    .sort((a, b) => b[1] - a[1]);

  // Generate the bar HTML
  let barHtml = '';
  sortedLanguages.forEach(([language, percentage]) => {
    const color = languageColors[language] || '#8b949e'; // Default color for unknown languages
    barHtml += `<span class="lang-bar" 
                    style="width: ${percentage}%; background-color: ${color};" 
                    title="${language}: ${percentage.toFixed(1)}%"></span>`;
  });

  // Generate the language list HTML
  let listHtml = '';
  sortedLanguages.forEach(([language, percentage]) => {
    if (percentage >= 0.1) { // Only show languages with at least 0.1%
      const color = languageColors[language] || '#8b949e';
      listHtml += `
        <li class="lang-item">
          <span class="lang-color" style="background-color: ${color};"></span>
          <span class="lang-name">${language}</span>
          <span class="lang-percent">${percentage.toFixed(1)}%</span>
        </li>
      `;
    }
  });

  // Complete HTML
  return `
    <div class="languages-section">
      <h4>Languages</h4>
      <div class="language-bar-container">
        ${barHtml}
      </div>
      <ul class="language-list">
        ${listHtml}
      </ul>
    </div>
  `;
}

// Function to display language statistics
function displayLanguageStats(languageData) {
    const languageStatsContainer = document.getElementById('languageStats');
    if (!languageStatsContainer) return;
    
    // Sort languages by percentage (descending)
    const sortedLanguages = Object.entries(languageData)
        .sort((a, b) => b[1] - a[1]);
    
    // Create the language bars (horizontal stacked bar)
    let barsHtml = '';
    sortedLanguages.forEach(([language, percentage]) => {
        const color = languageColors[language] || '#ddd';
        barsHtml += `<div class="language-bar" style="width: ${percentage}%; background-color: ${color};" 
                         title="${language}: ${percentage.toFixed(1)}%"></div>`;
    });
    
    // Create the language details
    let detailsHtml = '<div class="language-details mt-3">';
    sortedLanguages.forEach(([language, percentage]) => {
        if (percentage >= 0.1) { // Only show languages that are at least 0.1%
            const color = languageColors[language] || '#ddd';
            detailsHtml += `
                <div class="language-item">
                    <span class="language-color" style="background-color: ${color};"></span>
                    <span class="language-name">${language}</span>
                    <span class="language-percentage">${percentage.toFixed(1)}%</span>
                </div>
            `;
        }
    });
    detailsHtml += '</div>';
    
    // Update the DOM
    languageStatsContainer.innerHTML = barsHtml + detailsHtml;
}

// Initialize after the page loads
document.addEventListener('DOMContentLoaded', function() {
    initialize(); // This should be your main initialization function
});
</script>
</body>
</html>