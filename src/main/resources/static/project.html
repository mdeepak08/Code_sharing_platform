<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View - Code Sharing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/dashboard.html">Code Sharing Platform</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Project</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-light me-3" id="userInfo">Loading...</span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Project Header -->
        <div class="gh-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 id="projectTitle">Loading project...</h1>
                    <p class="description" id="projectDescription"></p>
                </div>
                <div class="d-flex gap-2">
                    <button class="gh-btn">
                        <i class="fa fa-star"></i> Star
                    </button>
                    <button class="gh-btn">
                        <i class="fa fa-code-fork"></i> Fork
                    </button>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="dropdown">
                    <button class="gh-btn dropdown-toggle" id="visibilityToggleBtn" data-bs-toggle="dropdown">
                        <i class="fa fa-lock" id="visibilityBtnIcon"></i>
                        <span id="visibilityBtnText">Private</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="makePublicOption">
                            <i class="fa fa-globe me-2"></i> Make public
                            <div class="small text-muted mt-1">Anyone on the internet can see this repository</div>
                        </a></li>
                        <li><a class="dropdown-item" href="#" id="makePrivateOption">
                            <i class="fa fa-lock me-2"></i> Make private
                            <div class="small text-muted mt-1">You choose who can see and commit to this repository</div>
                        </a></li>
                    </ul>
                </div>
                <button class="gh-btn" id="starBtn">
                    <i class="fa fa-star-o"></i> Star
                </button>
                <button class="gh-btn" id="forkBtn">
                    <i class="fa fa-code-fork"></i> Fork
                </button>
            </div>
            
            <div class="repo-stats">
                <div class="repo-stat">
                    <i class="fa fa-code-branch"></i>
                    <span id="branchCount">0</span> branches
                </div>
                <div class="repo-stat">
                    <i class="fa fa-tag"></i>
                    <span>0</span> tags
                </div>
                <div class="repo-stat">
                    <i class="fa fa-code"></i>
                    <span id="fileCount">0</span> files
                </div>
                <div class="repo-stat">
                    <i class="fa fa-user"></i>
                    Owner: <span id="projectOwner"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-calendar"></i>
                    Created: <span id="projectCreated"></span>
                </div>
                <div class="repo-stat">
                    <i class="fa fa-eye"></i>
                    <span id="projectVisibility"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb and Branch Selector -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item" id="projectNameBreadcrumb"></li>
                    <li class="breadcrumb-item active" id="currentPath">.</li>
                </ol>
            </nav>
            
            <div class="branch-dropdown">
                <button class="branch-selector dropdown-toggle" id="branchButton">
                    <i class="fa fa-code-branch"></i>
                    <span id="currentBranch">main</span>
                </button>
                <div class="branch-dropdown-content" id="branchDropdown">
                    <div class="branch-search">
                        <input type="text" placeholder="Find a branch..." id="branchSearchInput">
                    </div>
                    <div class="branch-dropdown-header">Branches</div>
                    <div class="branch-list" id="branchList">
                        <!-- Branch items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Explorer -->
        <div class="file-explorer mb-4">
            <div class="file-explorer-header">
                <div class="commit-info">
                    <img src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="User" class="commit-avatar">
                    <span id="lastCommitUser">User</span>
                    committed <span id="lastCommitTime">recently</span>
                </div>
                <a href="#" class="text-small text-decoration-none" id="commitsLink">
                    <i class="fa fa-history"></i> History
                </a>
            </div>
            
            <ul class="file-list" id="fileList">
                <!-- File items will be added here dynamically -->
                <li class="dir-item">
                    <i class="fa fa-folder file-icon file-dir-icon"></i>
                    <a href="#" class="dir-name">Loading...</a>
                </li>
            </ul>
        </div>
        
        <!-- Code Display (Only visible when a file is selected) -->
        <div class="code-container" id="codeContainer" style="display: none;">
            <div class="code-header">
                <div class="code-header-filename" id="currentFileName">No file selected</div>
                <div class="code-header-actions">
                    <a href="#" id="rawButton"><i class="fa fa-file-code"></i> Raw</a>
                    <a href="#" id="downloadButton"><i class="fa fa-download"></i> Download</a>
                    <a href="#" id="copyButton"><i class="fa fa-copy"></i> Copy</a>
                    <a href="#" id="fullScreenButton"><i class="fa fa-expand"></i> Full screen</a>
                </div>
            </div>
            <div class="code-content">
                <table class="code-blob" id="codeTable">
                    <tbody>
                        <!-- Code content with line numbers will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- GitHub-like Modal for Full Screen View -->
    <div class="github-modal" id="fullScreenModal">
        <div class="github-modal-content">
            <div class="github-modal-header">
                <h3 class="github-modal-title" id="modalFileName">File Name</h3>
                <button class="github-modal-close">&times;</button>
            </div>
            <div class="github-modal-body">
                <pre><code id="modalCode"></code></pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<style>
    :root {
        --gh-border-color: #e1e4e8;
        --gh-bg-color: #f6f8fa;
        --gh-text-color: #24292e;
        --gh-link-color: #0366d6;
        --gh-secondary-text: #586069;
        --gh-file-line-active: #fffbdd;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        color: var(--gh-text-color);
        line-height: 1.5;
    }
    
    .navbar {
        background-color: #24292e;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        padding: 0.5rem 1rem;
    }
    
    .gh-header {
        padding: 24px 0;
        border-bottom: 1px solid var(--gh-border-color);
        margin-bottom: 16px;
    }
    
    .gh-header h1 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 0;
    }
    
    .gh-header .description {
        font-size: 14px;
        color: var(--gh-secondary-text);
        margin-top: 8px;
    }
    
    .repo-stats {
        display: flex;
        gap: 16px;
        margin-top: 16px;
    }
    
    .repo-stat {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: var(--gh-secondary-text);
    }
    
    .branch-selector {
        background-color: var(--gh-bg-color);
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 5px 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gh-text-color);
        cursor: pointer;
    }
    
    .file-explorer {
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .file-explorer-header {
        background-color: var(--gh-bg-color);
        padding: 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .commit-info {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: var(--gh-secondary-text);
    }
    
    .commit-avatar {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 4px;
    }
    
    .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .file-item, .dir-item {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        align-items: center;
    }
    
    .file-item:hover, .dir-item:hover {
        background-color: #f8f9fa;
    }
    
    .file-item:last-child, .dir-item:last-child {
        border-bottom: none;
    }
    
    .file-icon {
        margin-right: 8px;
        color: var(--gh-secondary-text);
    }
    
    .file-dir-icon {
        color: #79b8ff;
    }
    
    .file-name {
        flex-grow: 1;
        font-size: 14px;
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .dir-name {
        flex-grow: 1;
        font-size: 14px;
        font-weight: 600;
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .commit-msg {
        font-size: 12px;
        color: var(--gh-secondary-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 400px;
        margin-left: auto;
        padding-left: 20px;
    }
    
    .code-container {
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .code-header {
        padding: 10px 16px;
        background-color: var(--gh-bg-color);
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .code-header-filename {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 14px;
        font-weight: 600;
    }
    
    .code-header-actions a {
        font-size: 14px;
        color: var(--gh-secondary-text);
        text-decoration: none;
        margin-left: 16px;
    }
    
    .code-content {
        overflow-x: auto;
    }
    
    .code-content pre {
        margin: 0;
        padding: 16px;
        overflow-y: hidden;
        background-color: white;
    }
    
    .code-content code {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 1.5;
        tab-size: 4;
    }
    
    .code-line-numbers {
        float: left;
        text-align: right;
        color: #aaa;
        border-right: 1px solid #e1e4e8;
        padding: 16px 8px 16px 16px;
        margin-right: 16px;
        user-select: none;
    }
    
    .breadcrumb-item a {
        color: var(--gh-link-color);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: var(--gh-text-color);
    }
    
    /* Styles for directory tree */
    .directory-structure {
        list-style-type: none;
        padding-left: 0;
    }
    
    .directory-structure li {
        padding: 4px 0;
    }
    
    .directory-structure ul {
        list-style-type: none;
        padding-left: 20px;
    }
    
    .directory-toggle {
        cursor: pointer;
        user-select: none;
    }
    
    .directory-toggle::before {
        content: "â–¶";
        display: inline-block;
        width: 12px;
        transition: transform 0.2s;
    }
    
    .directory-toggle.open::before {
        transform: rotate(90deg);
    }
    
    .file-content {
        display: none;
    }
    
    /* GitHub-like UI elements */
    .gh-btn {
        display: inline-flex;
        align-items: center;
        background-color: var(--gh-bg-color);
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        padding: 5px 12px;
        font-size: 14px;
        font-weight: 500;
        color: var(--gh-text-color);
        cursor: pointer;
        text-decoration: none;
        line-height: 20px;
    }
    
    .gh-btn:hover {
        background-color: #f3f4f6;
        text-decoration: none;
    }
    
    .gh-btn i {
        margin-right: 4px;
    }
    
    .gh-btn-primary {
        background-color: #2ea44f;
        border-color: rgba(27,31,35,0.15);
        color: white;
    }
    
    .gh-btn-primary:hover {
        background-color: #2c974b;
        color: white;
    }
    
    /* Branch dropdown */
    .branch-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .branch-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        width: 300px;
        background-color: white;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(149,157,165,0.2);
        margin-top: 4px;
    }
    
    .branch-dropdown-header {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
        font-size: 12px;
        font-weight: 600;
    }
    
    .branch-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 8px 0;
    }
    
    .branch-item {
        padding: 8px 16px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    .branch-item:hover {
        background-color: var(--gh-bg-color);
    }
    
    .branch-item.active {
        background-color: #0366d611;
    }
    
    .branch-item i {
        margin-right: 8px;
        color: var(--gh-secondary-text);
    }
    
    .branch-name {
        flex-grow: 1;
        font-size: 14px;
    }
    
    .dropdown-toggle::after {
        display: inline-block;
        margin-left: 6px;
        vertical-align: middle;
        content: "";
        border-top: 4px solid;
        border-right: 4px solid transparent;
        border-bottom: 0;
        border-left: 4px solid transparent;
    }
    
    .branch-search {
        padding: 8px 16px;
        border-bottom: 1px solid var(--gh-border-color);
    }
    
    .branch-search input {
        width: 100%;
        padding: 5px 12px;
        font-size: 14px;
        border: 1px solid var(--gh-border-color);
        border-radius: 6px;
    }
    
    /* GitHub code blob table */
    .code-blob {
        width: 100%;
        border-spacing: 0;
    }
    
    .code-blob tr:hover {
        background-color: var(--gh-bg-color);
    }
    
    .code-blob .line-number {
        width: 1%;
        min-width: 50px;
        padding-right: 10px;
        padding-left: 10px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 20px;
        color: var(--gh-secondary-text);
        text-align: right;
        white-space: nowrap;
        vertical-align: top;
        cursor: pointer;
        user-select: none;
    }
    
    .code-blob .line-content {
        padding-left: 10px;
        padding-right: 10px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 20px;
        white-space: pre;
        vertical-align: top;
    }
    
    /* Utility classes */
    .text-small {
        font-size: 12px !important;
    }
    
    .text-gray {
        color: var(--gh-secondary-text) !important;
    }
    
    .d-flex {
        display: flex !important;
    }
    
    .align-items-center {
        align-items: center !important;
    }
    
    /* Modal */
    .github-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .github-modal-content {
        position: relative;
        margin: 5% auto;
        width: 80%;
        max-width: 900px;
        background-color: #fff;
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(149,157,165,0.2);
    }
    
    .github-modal-header {
        padding: 16px;
        border-bottom: 1px solid var(--gh-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .github-modal-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }
    
    .github-modal-close {
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    
    .github-modal-body {
        padding: 16px;
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* For mobile responsiveness */
    @media (max-width: 768px) {
        .commit-msg {
            display: none;
        }
        
        .code-header-actions {
            display: none;
        }
        
        .repo-stats {
            flex-wrap: wrap;
        }
    }
</style>
<script>
// Check authentication
const token = localStorage.getItem('jwt_token');
if (!token) {
    window.location.href = '/login.html';
}

// Global variables
let currentProject = null;
let projectFiles = [];
let projectBranches = [];
let currentBranch = 'main';
let currentPath = '';

// DOM Elements
const branchButton = document.getElementById('branchButton');
const branchDropdown = document.getElementById('branchDropdown');
const branchList = document.getElementById('branchList');
const branchSearchInput = document.getElementById('branchSearchInput');
const fullScreenModal = document.getElementById('fullScreenModal');
const modalClose = document.querySelector('.github-modal-close');

// Get project ID from URL
const urlParams = new URLSearchParams(window.location.search);
const projectId = urlParams.get('id');

if (!projectId) {
    alert('Project ID is missing');
    window.location.href = '/dashboard.html';
}

// Functions
function logout() {
    localStorage.removeItem('jwt_token');
    window.location.href = '/login.html';
}

// Initialize
async function initialize() {
    await loadUserInfo();
    await loadProjectDetails();
    await loadProjectFiles();
    await loadProjectBranches();
    setupEventListeners();
    updateStarButton();
}

// Load user info
async function loadUserInfo() {
    try {
        const response = await fetch('/api/auth/user', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                document.getElementById('userInfo').textContent = `Welcome, ${result.data.username}`;
            } else {
                document.getElementById('userInfo').textContent = 'Welcome';
            }
        } else {
            console.error('Failed to load user info');
            document.getElementById('userInfo').textContent = 'Welcome';
        }
    } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('userInfo').textContent = 'Welcome';
    }
}

// Load project details
async function loadProjectDetails() {
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    currentProject = result.data;
                    
                    // Update page elements
                    document.title = `${currentProject.name} - Code Sharing Platform`;
                    document.getElementById('projectTitle').textContent = currentProject.name;
                    document.getElementById('projectNameBreadcrumb').textContent = currentProject.name;
                    document.getElementById('projectNameBreadcrumb').innerHTML = `<a href="#">${currentProject.name}</a>`;
                    document.getElementById('projectDescription').textContent = currentProject.description || 'No description provided';
                    document.getElementById('projectOwner').textContent = currentProject.owner.username;
                    document.getElementById('projectCreated').textContent = new Date(currentProject.createdAt).toLocaleDateString();
                    
                    // Set visibility status and update UI
                    const isPublic = currentProject.isPublic !== undefined ? currentProject.isPublic : currentProject.public;
                    document.getElementById('projectVisibility').textContent = isPublic ? 'Public' : 'Private';
                    updateVisibilityDisplay(isPublic);
                    
                    /* Rest of your existing code */
                } else {
                    alert('Failed to load project details');
                    window.location.href = '/dashboard.html';
                }
            } else {
                alert('Failed to load project details');
                window.location.href = '/dashboard.html';
            }
        } catch (error) {
            console.error('Error loading project details:', error);
            alert('Failed to load project details');
            window.location.href = '/dashboard.html';
        }
    }

// Load project files
async function loadProjectFiles() {
    try {
        const response = await fetch(`/api/files/project/${projectId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                projectFiles = result.data;
                document.getElementById('fileCount').textContent = projectFiles.length;
                displayFiles(buildFileTree(projectFiles));
            } else {
                document.getElementById('fileList').innerHTML = '<li class="file-item"><span class="text-muted">No files yet. Add some!</span></li>';
            }
        } else {
            document.getElementById('fileList').innerHTML = '<li class="file-item"><div class="alert alert-danger">Failed to load files</div></li>';
        }
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('fileList').innerHTML = '<li class="file-item"><div class="alert alert-danger">Failed to load files</div></li>';
    }
}
// Load project branches
async function loadProjectBranches() {
    try {
        const response = await fetch(`/api/branches/project/${projectId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                projectBranches = result.data;
                document.getElementById('branchCount').textContent = projectBranches.length;
                
                // Find default branch
                const defaultBranch = projectBranches.find(branch => branch.default);
                if (defaultBranch) {
                    currentBranch = defaultBranch.name;
                    document.getElementById('currentBranch').textContent = currentBranch;
                }
                
                // Populate branch dropdown
                populateBranchDropdown();
            }
        } else {
            console.error('Failed to load branches');
        }
    } catch (error) {
        console.error('Error loading branches:', error);
    }
}

// Populate branch dropdown
function populateBranchDropdown() {
    branchList.innerHTML = '';
    
    projectBranches.forEach(branch => {
        const branchItem = document.createElement('div');
        branchItem.className = `branch-item ${branch.name === currentBranch ? 'active' : ''}`;
        branchItem.dataset.branch = branch.name;
        
        branchItem.innerHTML = `
            <i class="fa fa-code-branch"></i>
            <span class="branch-name">${branch.name}</span>
            ${branch.default ? '<span class="badge bg-success text-small">default</span>' : ''}
        `;
        
        branchItem.addEventListener('click', function() {
            currentBranch = this.dataset.branch;
            document.getElementById('currentBranch').textContent = currentBranch;
            branchDropdown.style.display = 'none';
            loadProjectFiles(); // Reload files for the new branch
        });
        
        branchList.appendChild(branchItem);
    });
}

// Build file tree from flat list
function buildFileTree(files) {
    const root = { type: 'dir', name: '', path: '', children: {} };
    
    files.forEach(file => {
        let path = file.path;
        let parts = path.split('/');
        
        let currentDir = root;
        let currentPath = '';
        
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!part) continue;
            
            currentPath = currentPath ? `${currentPath}/${part}` : part;
            
            if (!currentDir.children[part]) {
                currentDir.children[part] = {
                    type: 'dir',
                    name: part,
                    path: currentPath,
                    children: {}
                };
            }
            
            currentDir = currentDir.children[part];
        }
        
        const fileName = parts[parts.length - 1];
        if (fileName) {
            currentDir.children[fileName] = {
                type: 'file',
                name: fileName,
                path: file.path,
                id: file.id,
                content: file.content
            };
        }
    });
    
    return root;
}

// Display files
function displayFiles(root) {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    // Add parent directory link if we're in a subdirectory
    if (currentPath !== '') {
        const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
        const parentItem = document.createElement('li');
        parentItem.className = 'dir-item';
        parentItem.innerHTML = `
            <i class="fa fa-folder file-icon file-dir-icon"></i>
            <a href="#" class="dir-name" data-path="${parentPath}">..</a>
        `;
        parentItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(parentPath);
        });
        fileList.appendChild(parentItem);
    }
    
    // Find current directory based on path
    let currentDir = root;
    if (currentPath) {
        const pathParts = currentPath.split('/');
        for (const part of pathParts) {
            if (part && currentDir.children && currentDir.children[part]) {
                currentDir = currentDir.children[part];
            }
        }
    }
    
    // Display directories first
    const dirEntries = [];
    const fileEntries = [];
    
    for (const name in currentDir.children) {
        const entry = currentDir.children[name];
        if (entry.type === 'dir') {
            dirEntries.push(entry);
        } else {
            fileEntries.push(entry);
        }
    }
    
    // Sort entries by name
    dirEntries.sort((a, b) => a.name.localeCompare(b.name));
    fileEntries.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add directories
    dirEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'dir-item';
        listItem.innerHTML = `
            <i class="fa fa-folder file-icon file-dir-icon"></i>
            <a href="#" class="dir-name" data-path="${entry.path}">${entry.name}</a>
        `;
        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            navigateToPath(entry.path);
        });
        fileList.appendChild(listItem);
    });
    
    // Add files
    fileEntries.forEach(entry => {
        const listItem = document.createElement('li');
        listItem.className = 'file-item';
        
        // Determine file icon based on extension
        let fileIconClass = 'fa-file';
        const ext = entry.name.split('.').pop().toLowerCase();
        if (['java', 'js', 'ts', 'py', 'rb', 'php', 'c', 'cpp', 'h', 'cs'].includes(ext)) {
            fileIconClass = 'fa-file-code';
        } else if (['md', 'txt', 'log'].includes(ext)) {
            fileIconClass = 'fa-file-alt';
        } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
            fileIconClass = 'fa-file-image';
        } else if (['pdf'].includes(ext)) {
            fileIconClass = 'fa-file-pdf';
        } else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) {
            fileIconClass = 'fa-file-archive';
        } else if (['doc', 'docx'].includes(ext)) {
            fileIconClass = 'fa-file-word';
        } else if (['xls', 'xlsx'].includes(ext)) {
            fileIconClass = 'fa-file-excel';
        } else if (['ppt', 'pptx'].includes(ext)) {
            fileIconClass = 'fa-file-powerpoint';
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
            fileIconClass = 'fa-file-audio';
        } else if (['mp4', 'avi', 'mov', 'wmv'].includes(ext)) {
            fileIconClass = 'fa-file-video';
        }
        
        listItem.innerHTML = `
            <i class="fa ${fileIconClass} file-icon"></i>
            <a href="#" class="file-name" data-file-id="${entry.id}">${entry.name}</a>
            <span class="commit-msg">Updated recently</span>
        `;
        
        listItem.querySelector('a').addEventListener('click', function(e) {
            e.preventDefault();
            loadFile(entry.id);
        });
        
        fileList.appendChild(listItem);
    });
    
    // Update current path display
    document.getElementById('currentPath').textContent = currentPath || '.';
}
// Navigate to directory path
function navigateToPath(path) {
    currentPath = path;
    // Re-display files for the new path
    displayFiles(buildFileTree(projectFiles));
    // Hide code display when navigating
    document.getElementById('codeContainer').style.display = 'none';
}

// Load file content
async function loadFile(fileId) {
    try {
        const response = await fetch(`/api/files/${fileId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                const file = result.data;
                displayFileContent(file);
            } else {
                alert('Failed to load file content');
            }
        } else {
            alert('Failed to load file content');
        }
    } catch (error) {
        console.error('Error loading file content:', error);
        alert('Failed to load file content');
    }
}

// Display file content
function displayFileContent(file) {
    // Update file name in header
    document.getElementById('currentFileName').textContent = file.name;
    
    // Get the code container and make it visible
    const codeContainer = document.getElementById('codeContainer');
    codeContainer.style.display = 'block';
    
    // Build the code table with line numbers
    const codeTable = document.getElementById('codeTable');
    codeTable.innerHTML = '';
    
    // Split content by lines and add line numbers
    const lines = file.content ? file.content.split('\n') : ['No content'];
    
    lines.forEach((line, index) => {
        const row = document.createElement('tr');
        
        // Line number cell
        const lineNumberCell = document.createElement('td');
        lineNumberCell.className = 'line-number';
        lineNumberCell.textContent = index + 1;
        lineNumberCell.dataset.lineNumber = index + 1;
        row.appendChild(lineNumberCell);
        
        // Line content cell
        const lineContentCell = document.createElement('td');
        lineContentCell.className = 'line-content';
        lineContentCell.textContent = line;
        row.appendChild(lineContentCell);
        
        codeTable.appendChild(row);
    });
    
    // Set up the raw button link
    document.getElementById('rawButton').href = `/api/files/${file.id}/raw`;
    
    // Set up download button
    document.getElementById('downloadButton').href = `/api/files/${file.id}/raw`;
    document.getElementById('downloadButton').download = file.name;
    
    // Scroll to top of page
    window.scrollTo(0, 0);
    
    // Update modal data for full screen view
    document.getElementById('modalFileName').textContent = file.name;
    document.getElementById('modalCode').textContent = file.content || 'No content';
    
    // Apply syntax highlighting based on file extension
    applyCodeHighlighting(file.name);
}

// Apply syntax highlighting
function applyCodeHighlighting(fileName) {
    // Get file extension
    const ext = fileName.split('.').pop().toLowerCase();
    
    // Map of extensions to highlight.js language classes
    const languageMap = {
        'js': 'javascript',
        'jsx': 'javascript',
        'ts': 'typescript',
        'tsx': 'typescript',
        'html': 'html',
        'xml': 'xml',
        'css': 'css',
        'scss': 'scss',
        'sass': 'scss',
        'less': 'less',
        'java': 'java',
        'py': 'python',
        'rb': 'ruby',
        'php': 'php',
        'c': 'c',
        'cpp': 'cpp',
        'h': 'cpp',
        'cs': 'csharp',
        'go': 'go',
        'rs': 'rust',
        'swift': 'swift',
        'kt': 'kotlin',
        'md': 'markdown',
        'json': 'json',
        'yml': 'yaml',
        'yaml': 'yaml',
        'sql': 'sql',
        'sh': 'bash',
        'bat': 'batch',
        'ps1': 'powershell',
        'dockerfile': 'dockerfile',
        'properties': 'properties',
        'gradle': 'gradle'
    };
    
    // Set class on modal code element for highlighting
    const language = languageMap[ext] || '';
    if (language) {
        const modalCode = document.getElementById('modalCode');
        modalCode.className = `language-${language}`;
        
        // Initialize highlight.js
        if (window.hljs) {
            window.hljs.highlightElement(modalCode);
        }
    }
}
        // Add these functions to the project.html JavaScript:

        // Toggle star status
        function toggleStar() {
            const projectId = parseInt(urlParams.get('id'));
            
            // Get current starred repos from localStorage
            let starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
            
            const isStarred = starredRepoIds.includes(projectId);
            
            if (isStarred) {
                // Remove from starred
                starredRepoIds = starredRepoIds.filter(id => id !== projectId);
            } else {
                // Add to starred
                starredRepoIds.push(projectId);
            }
            
            // Update localStorage
            localStorage.setItem('starredRepos', JSON.stringify(starredRepoIds));
            
            // Update UI
            const starButton = document.querySelector('.gh-btn:nth-child(1)');
            if (starButton) {
                starButton.innerHTML = isStarred ? 
                    '<i class="fa fa-star-o"></i> Star' : 
                    '<i class="fa fa-star"></i> Unstar';
            }
        }

        // Fork repository
        function forkRepository() {
            const projectId = parseInt(urlParams.get('id'));
            alert('Repository forked successfully! (This is a simulation)');
        }

        // Update event listeners in setupEventListeners function:
        document.querySelector('.gh-btn:nth-child(1)').addEventListener('click', toggleStar);
        document.querySelector('.gh-btn:nth-child(2)').addEventListener('click', forkRepository);

        // Add this to the initialize function:
        // Check if repository is already starred and update UI
        function updateStarButton() {
            const projectId = parseInt(urlParams.get('id'));
            const starredRepoIds = JSON.parse(localStorage.getItem('starredRepos') || '[]');
            const isStarred = starredRepoIds.includes(projectId);
            
            const starButton = document.querySelector('.gh-btn:nth-child(1)');
            if (starButton) {
                starButton.innerHTML = isStarred ? 
                    '<i class="fa fa-star"></i> Unstar' : 
                    '<i class="fa fa-star-o"></i> Star';
            }
        }

    // Set up event listeners
    function setupEventListeners() {
    // Branch dropdown toggle
    branchButton.addEventListener('click', function() {
        if (branchDropdown.style.display === 'block') {
            branchDropdown.style.display = 'none';
        } else {
            branchDropdown.style.display = 'block';
            branchSearchInput.focus();
        }
    });
    
    // Branch search
    branchSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const branchItems = branchList.querySelectorAll('.branch-item');
        
        branchItems.forEach(item => {
            const branchName = item.querySelector('.branch-name').textContent.toLowerCase();
            if (branchName.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!branchButton.contains(event.target) && !branchDropdown.contains(event.target)) {
            branchDropdown.style.display = 'none';
        }
    });

            // Visibility toggle event listeners
            document.getElementById('makePublicOption').addEventListener('click', function(e) {
            e.preventDefault();
            toggleProjectVisibility(true);
        });
        
        document.getElementById('makePrivateOption').addEventListener('click', function(e) {
            e.preventDefault();
            toggleProjectVisibility(false);
        });
    
    // Copy button
    document.getElementById('copyButton').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Get content from lines
        const lineContents = document.querySelectorAll('.line-content');
        let content = '';
        lineContents.forEach(line => {
            content += line.textContent + '\n';
        });
        
        // Copy to clipboard
        navigator.clipboard.writeText(content).then(function() {
            alert('Content copied to clipboard!');
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
        });
    });
    
    // Full screen button
    document.getElementById('fullScreenButton').addEventListener('click', function(e) {
        e.preventDefault();
        fullScreenModal.style.display = 'block';
        
        // Apply syntax highlighting
        if (window.hljs) {
            window.hljs.highlightElement(document.getElementById('modalCode'));
        }
    });
    
    // Close modal
    modalClose.addEventListener('click', function() {
        fullScreenModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === fullScreenModal) {
            fullScreenModal.style.display = 'none';
        }
    });
}
document.head.insertAdjacentHTML('beforeend', `
        <style>
            #toast-container {
                z-index: 1050;
            }
            
            .toast {
                min-width: 250px;
                margin-bottom: 10px;
            }
            
            .toast-success {
                background-color: #d4edda;
                border-color: #c3e6cb;
            }
            
            .toast-success .toast-header {
                background-color: #c3e6cb;
                color: #155724;
            }
            
            .toast-error {
                background-color: #f8d7da;
                border-color: #f5c6cb;
            }
            
            .toast-error .toast-header {
                background-color: #f5c6cb;
                color: #721c24;
            }
        </style>
    `);
 // Toggle project visibility
 async function toggleProjectVisibility(makePublic) {
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    isPublic: makePublic
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Update UI to reflect the new visibility status
                updateVisibilityDisplay(makePublic);
                
                // Show toast notification
                const message = makePublic ? 
                    'Repository is now public - anyone can see it' : 
                    'Repository is now private - only you and collaborators can see it';
                showToast(message, 'success');
            } else {
                throw new Error(result.message || 'Failed to update project visibility');
            }
        } catch (error) {
            console.error('Error updating project visibility:', error);
            showToast('Failed to update repository visibility', 'error');
        }
    }

    // Update visibility display based on state
    function updateVisibilityDisplay(isPublic) {
        // Update button icon and text
        const visibilityBtnIcon = document.getElementById('visibilityBtnIcon');
        const visibilityBtnText = document.getElementById('visibilityBtnText');
        
        // Update project stats indicator
        const projectVisibility = document.getElementById('projectVisibility');
        
        // Update dropdown options
        const makePublicOption = document.getElementById('makePublicOption');
        const makePrivateOption = document.getElementById('makePrivateOption');
        
        if (isPublic) {
            visibilityBtnIcon.className = 'fa fa-globe';
            visibilityBtnText.textContent = 'Public';
            projectVisibility.textContent = 'Public';
            makePublicOption.style.display = 'none';
            makePrivateOption.style.display = 'block';
        } else {
            visibilityBtnIcon.className = 'fa fa-lock';
            visibilityBtnText.textContent = 'Private';
            projectVisibility.textContent = 'Private';
            makePublicOption.style.display = 'block';
            makePrivateOption.style.display = 'none';
        }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        // Simple implementation - you can enhance this with a proper toast library
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }


// Initialize highlight.js
document.addEventListener('DOMContentLoaded', function() {
    // Load common languages
    if (window.hljs) {
        hljs.highlightAll();
    }
});

// Start the application
initialize();
</script>
</body>
</html>