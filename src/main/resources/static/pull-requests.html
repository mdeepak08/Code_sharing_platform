<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pull Requests - Code Sharing Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dark-theme.css">
    <script src="/js/theme-switcher.js" defer></script>
    <style>
        :root {
            --gh-dark: #24292e;
            --gh-green: #2ea44f;
            --gh-blue: #0366d6;
            --gh-gray: #586069;
            --gh-bg: #f6f8fa;
            --gh-border: #e1e4e8;
            --gh-hover: #f1f1f1;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            color: #24292e;
            background-color: #f6f8fa;
        }
        
        .navbar {
            background-color: var(--gh-dark);
            padding: 0.75rem 1rem;
        }
        
        .navbar-brand {
            font-weight: 600;
        }
        
        .avatar-img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .avatar-img-medium {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .pr-item {
            border: 1px solid var(--gh-border);
            border-radius: 6px;
            background-color: #fff;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }
        
        .pr-item:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .pr-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            border-bottom: 1px solid var(--gh-border);
        }
        
        .pr-title {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .pr-title a {
            color: var(--gh-blue);
            text-decoration: none;
        }
        
        .pr-title a:hover {
            text-decoration: underline;
        }
        
        .pr-meta {
            color: var(--gh-gray);
            font-size: 12px;
        }
        
        .pr-status {
            display: flex;
            align-items: center;
            margin-left: 12px;
        }
        
        .status-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .status-open {
            background-color: #dcffe4;
            color: #24663b;
        }
        
        .status-merged {
            background-color: #ddf4ff;
            color: #0366d6;
        }
        
        .status-closed {
            background-color: #ffeef0;
            color: #d73a49;
        }
        
        .filter-btn {
            display: flex;
            align-items: center;
            margin-right: 8px;
            background: transparent;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 14px;
            color: var(--gh-gray);
            cursor: pointer;
        }
        
        .filter-btn.active {
            background-color: var(--gh-bg);
            color: var(--gh-dark);
            font-weight: 500;
        }
        
        .filter-btn i {
            margin-right: 4px;
        }
        
        .filter-count {
            margin-left: 4px;
            font-weight: 500;
        }
        
        .empty-state {
            padding: 64px 32px;
            text-align: center;
            background-color: #fff;
            border: 1px solid var(--gh-border);
            border-radius: 6px;
        }
        
        .empty-state-icon {
            color: #d0d7de;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .project-badge {
            background-color: #eef2ff;
            color: #4338ca;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 8px;
        }
        
        .dropdown-filter {
            min-width: 200px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="/dashboard.html">
                <i class="fa fa-code-branch me-2"></i>
                Code Sharing Platform
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/explore.html">Explore</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/pull-requests.html">Pull Requests</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Issues</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                            <img src="https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y" alt="User" class="avatar-img" id="navbarUserAvatar">
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header" id="userDropdownName">User</h6></li>
                            <li><a class="dropdown-item" href="#">Your profile</a></li>
                            <li><a class="dropdown-item" href="#">Your repositories</a></li>
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Sign out</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">Pull Requests</h2>
                <p class="text-muted mb-0" id="pullRequestsCount">Loading pull requests...</p>
            </div>
        </div>
        
        <!-- Pull Request Filters -->
        <div class="d-flex flex-wrap align-items-center mb-3">
            <div class="d-flex me-auto mb-2 mb-md-0">
                <button class="filter-btn active" data-status="OPEN">
                    <i class="fa fa-exclamation-circle"></i>
                    Open
                    <span class="filter-count" id="openCount">0</span>
                </button>
                <button class="filter-btn" data-status="CLOSED">
                    <i class="fa fa-check-circle"></i>
                    Closed
                    <span class="filter-count" id="closedCount">0</span>
                </button>
                <button class="filter-btn" data-status="MERGED">
                    <i class="fa fa-code-merge"></i>
                    Merged
                    <span class="filter-count" id="mergedCount">0</span>
                </button>
            </div>
            
            <div class="d-flex flex-wrap">
                <div class="dropdown me-2 mb-2 mb-md-0">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="projectFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-filter me-1"></i> Project: All
                    </button>
                    <ul class="dropdown-menu dropdown-filter" id="projectFilterDropdown">
                        <li><a class="dropdown-item active" href="#" data-project-id="all">All projects</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <!-- Projects will be populated here -->
                        <li><div class="dropdown-item text-center" id="projectsLoadingIndicator">Loading projects...</div></li>
                    </ul>
                </div>
                
                <div class="dropdown me-2 mb-2 mb-md-0">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="authorFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-user me-1"></i> Author: Me
                    </button>
                    <ul class="dropdown-menu dropdown-filter" id="authorFilterDropdown">
                        <li><a class="dropdown-item active" href="#" data-author="me">Created by me</a></li>
                        <li><a class="dropdown-item" href="#" data-author="assigned">Assigned to me</a></li>
                        <li><a class="dropdown-item" href="#" data-author="mentioned">Mentioning me</a></li>
                        <li><a class="dropdown-item" href="#" data-author="all">All pull requests</a></li>
                    </ul>
                </div>
                
                <div class="input-group me-2 mb-2 mb-md-0" style="width: auto;">
                    <input type="text" class="form-control" placeholder="Search pull requests..." id="searchInput">
                    <button class="btn btn-outline-secondary" type="button" id="searchButton">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-sort me-1"></i> Sort: Newest
                    </button>
                    <ul class="dropdown-menu dropdown-filter" id="sortFilterDropdown">
                        <li><a class="dropdown-item active" href="#" data-sort="newest">Newest</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="oldest">Oldest</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="recently-updated">Recently updated</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="least-updated">Least recently updated</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="most-commented">Most commented</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Pull Requests List -->
        <div id="pullRequestsList" class="mt-4">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Pull requests pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated by JavaScript -->
            </ul>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Global variables
        let currentStatus = 'OPEN';
        let searchQuery = '';
        let pullRequests = [];
        let counts = { OPEN: 0, CLOSED: 0, MERGED: 0 };
        let userProjects = [];
        let selectedProjectId = 'all';
        let selectedAuthorFilter = 'me';
        let selectedSort = 'newest';
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        
        // DOM Elements
        const pullRequestsList = document.getElementById('pullRequestsList');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const projectFilterDropdown = document.getElementById('projectFilterDropdown');
        const authorFilterDropdown = document.getElementById('authorFilterDropdown');
        const sortFilterDropdown = document.getElementById('sortFilterDropdown');
        const projectFilterBtn = document.getElementById('projectFilterBtn');
        const authorFilterBtn = document.getElementById('authorFilterBtn');
        const sortFilterBtn = document.getElementById('sortFilterBtn');
        const pullRequestsCount = document.getElementById('pullRequestsCount');
        const pagination = document.getElementById('pagination');
        
        // Functions
        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/login.html';
        }
        
        // Initialize
        async function initialize() {
            // Load user info
            await loadUserInfo();
            
            // Load user's projects
            await loadUserProjects();
            
            // Load user's pull requests
            await loadUserPullRequests();
            
            // Set up event listeners
            setupEventListeners();
        }
        
        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const user = result.data;
                        
                        // Update user dropdown
                        document.getElementById('userDropdownName').textContent = user.username;
                        
                        // Update avatar if available
                        if (user.avatarUrl) {
                            document.getElementById('navbarUserAvatar').src = user.avatarUrl;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }
        
        // Load user's projects
        async function loadUserProjects() {
            try {
                const response = await fetch('/api/projects', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        userProjects = result.data;
                        
                        // Remove loading indicator
                        document.getElementById('projectsLoadingIndicator').remove();
                        
                        // Populate project filter dropdown
                        userProjects.forEach(project => {
                            const item = document.createElement('li');
                            item.innerHTML = `<a class="dropdown-item" href="#" data-project-id="${project.id}">${project.name}</a>`;
                            projectFilterDropdown.appendChild(item);
                            
                            // Add click event
                            item.querySelector('a').addEventListener('click', function(e) {
                                e.preventDefault();
                                handleProjectFilterChange(this);
                            });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading user projects:', error);
                document.getElementById('projectsLoadingIndicator').textContent = 'Error loading projects';
            }
        }
        
        // Load user's pull requests
        async function loadUserPullRequests() {
            try {
                // Show loading spinner
                pullRequestsList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                // Build the API URL with filters
                let apiUrl = '/api/pull-requests/user';
                
                // Apply filters
                let queryParams = [];
                
                // Status filter
                queryParams.push(`status=${currentStatus.toLowerCase()}`);
                
                // Author filter
                queryParams.push(`filter=${selectedAuthorFilter}`);
                
                // Sort filter
                queryParams.push(`sort=${selectedSort}`);
                
                // Search filter
                if (searchQuery) {
                    queryParams.push(`search=${encodeURIComponent(searchQuery)}`);
                }
                
                // Project filter
                if (selectedProjectId !== 'all') {
                    queryParams.push(`projectId=${selectedProjectId}`);
                }
                
                // Page filter
                queryParams.push(`page=${currentPage - 1}`); // API uses 0-based pagination
                queryParams.push(`size=${itemsPerPage}`);
                
                // Combine all query parameters
                if (queryParams.length > 0) {
                    apiUrl += '?' + queryParams.join('&');
                }
                
                // Make API request
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Extract pull requests and metadata
                        pullRequests = result.data.pullRequests || result.data;
                        
                        // Update counts if available
                        if (result.data.totalCount !== undefined) {
                            // If pagination info is available
                            totalPages = Math.ceil(result.data.totalCount / itemsPerPage);
                            pullRequestsCount.textContent = `Showing ${pullRequests.length} of ${result.data.totalCount} pull requests`;
                        } else {
                            // Simple count
                            pullRequestsCount.textContent = `${pullRequests.length} pull requests`;
                            totalPages = 1;
                        }
                        
                        // Update counts for each status
                        updateStatusCounts();
                        
                        // Display pull requests
                        displayPullRequests();
                        
                        // Update pagination
                        updatePagination();
                    } else {
                        showEmptyState();
                    }
                } else {
                    throw new Error('Failed to load pull requests');
                }
            } catch (error) {
                console.error('Error loading pull requests:', error);
                pullRequestsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fa fa-exclamation-triangle fa-3x"></i>
                        </div>
                        <h3>Error loading pull requests</h3>
                        <p class="text-muted">Please try again later.</p>
                    </div>
                `;
            }
        }

        // Update status counts based on the current pull requests
        async function updateStatusCounts() {
            try {
                // Make API request to get counts
                const response = await fetch('/api/pull-requests/user/count', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        counts = {
                            OPEN: result.data.open || 0,
                            CLOSED: result.data.closed || 0,
                            MERGED: result.data.merged || 0
                        };
                    }
                } else {
                    // Fallback to counting the loaded pull requests
                    counts = {
                        OPEN: pullRequests.filter(pr => pr.status === 'OPEN').length,
                        CLOSED: pullRequests.filter(pr => pr.status === 'CLOSED').length,
                        MERGED: pullRequests.filter(pr => pr.status === 'MERGED').length
                    };
                }
                
                // Update count badges
                document.getElementById('openCount').textContent = counts.OPEN;
                document.getElementById('closedCount').textContent = counts.CLOSED;
                document.getElementById('mergedCount').textContent = counts.MERGED;
            } catch (error) {
                console.error('Error updating status counts:', error);
            }
        }
        
        // Display pull requests
        function displayPullRequests() {
            if (pullRequests.length === 0) {
                showEmptyState();
                return;
            }
            
            pullRequestsList.innerHTML = '';
            
            pullRequests.forEach(pr => {
                // Determine status class
                const statusClass = 
                    pr.status === 'OPEN' ? 'status-open' : 
                    pr.status === 'MERGED' ? 'status-merged' : 'status-closed';
                
                // Determine status icon
                const statusIcon = 
                    pr.status === 'OPEN' ? 'fa-exclamation-circle' : 
                    pr.status === 'MERGED' ? 'fa-code-merge' : 'fa-check-circle';
                
                // Get project info
                const projectName = pr.project ? pr.project.name : 'Unknown Project';
                const projectId = pr.project ? pr.project.id : '';
                
                // Create pull request item
                const prItem = document.createElement('div');
                prItem.className = 'pr-item';
                prItem.innerHTML = `
                    <div class="pr-header">
                        <div>
                            <div class="pr-title">
                                <a href="/pull-request.html?id=${pr.id}&projectId=${projectId}">${pr.title}</a>
                            </div>
                            <div class="pr-meta">
                                <span class="project-badge">${projectName}</span>
                                #${pr.id} opened ${timeAgo(new Date(pr.createdAt))} by 
                                <img src="https://www.gravatar.com/avatar/${hashString(pr.author.username)}?d=mp&f=y" 
                                    alt="${pr.author.username}" class="avatar-img" width="16" height="16">
                                <strong>${pr.author.username}</strong>
                            </div>
                        </div>
                        <div class="pr-status">
                            <span class="status-badge ${statusClass}">
                                <i class="fa ${statusIcon} me-1"></i> ${pr.status}
                            </span>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="mb-2">${pr.description || 'No description provided'}</div>
                        <div class="d-flex align-items-center text-muted small">
                            <div class="me-3">
                                <i class="fa fa-code-branch me-1"></i> 
                                ${pr.sourceBranch ? pr.sourceBranch.name : ''} â†’ ${pr.targetBranch ? pr.targetBranch.name : ''}
                            </div>
                            ${pr.mergeable !== undefined ? 
                                (pr.mergeable ? 
                                    '<div class="text-success"><i class="fa fa-check-circle me-1"></i> Mergeable</div>' : 
                                    '<div class="text-danger"><i class="fa fa-exclamation-triangle me-1"></i> Conflicts</div>'
                                ) : ''
                            }
                        </div>
                    </div>
                `;
                
                pullRequestsList.appendChild(prItem);
            });
        }
        
        // Show empty state
        function showEmptyState() {
            let message = '';
            let description = '';
            
            if (searchQuery) {
                message = 'No pull requests found matching your search.';
                description = 'Try adjusting your search or filter criteria.';
            } else if (selectedProjectId !== 'all') {
                const projectName = userProjects.find(p => p.id.toString() === selectedProjectId)?.name || 'this project';
                message = `No ${currentStatus.toLowerCase()} pull requests found for ${projectName}.`;
                description = 'Create a new pull request to propose and collaborate on changes.';
            } else {
                message = `No ${currentStatus.toLowerCase()} pull requests found.`;
                
                if (selectedAuthorFilter === 'me') {
                    description = 'You haven\'t created any pull requests yet.';
                } else if (selectedAuthorFilter === 'assigned') {
                    description = 'No pull requests are assigned to you for review.';
                } else if (selectedAuthorFilter === 'mentioned') {
                    description = 'No pull requests mention you.';
                } else {
                    description = 'No pull requests found with the current filters.';
                }
            }
            
            pullRequestsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fa fa-code-pull-request fa-3x"></i>
                    </div>
                    <h3>${message}</h3>
                    <p class="text-muted">${description}</p>
                </div>
            `;
            
            // Update pull request count
            pullRequestsCount.textContent = '0 pull requests';
            
            // Hide pagination
            pagination.innerHTML = '';
        }
        
        // Update pagination controls
        function updatePagination() {
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            
            // Page numbers
            const maxPages = 5; // Maximum number of page links to show
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            // First page
            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="1">1</a>
                    </li>
                `;
                
                if (startPage > 2) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                    `;
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                    `;
                }
                
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>
                    </li>
                `;
            }
            
            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
            
            // Add event listeners to pagination links
            document.querySelectorAll('.page-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page >= 1 && page <= totalPages && page !== currentPage) {
                        currentPage = page;
                        loadUserPullRequests();
                    }
                });
            });
        }
        
        // Handle project filter change
        function handleProjectFilterChange(element) {
            // Update active class
            document.querySelectorAll('#projectFilterDropdown .dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update selected project
            selectedProjectId = element.getAttribute('data-project-id');
            
            // Update button text
            let buttonText = 'Project: ';
            if (selectedProjectId === 'all') {
                buttonText += 'All';
            } else {
                const project = userProjects.find(p => p.id.toString() === selectedProjectId);
                buttonText += project ? project.name : 'Selected';
            }
            
            projectFilterBtn.innerHTML = `<i class="fa fa-filter me-1"></i> ${buttonText}`;
            
            // Reset to first page
            currentPage = 1;
            
            // Reload pull requests
            loadUserPullRequests();
        }
        
        // Handle author filter change
        function handleAuthorFilterChange(element) {
            // Update active class
            document.querySelectorAll('#authorFilterDropdown .dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update selected author filter
            selectedAuthorFilter = element.getAttribute('data-author');
            
            // Update button text
            let buttonText = 'Author: ';
            switch (selectedAuthorFilter) {
                case 'me':
                    buttonText += 'Me';
                    break;
                case 'assigned':
                    buttonText += 'Assigned to me';
                    break;
                case 'mentioned':
                    buttonText += 'Mentioning me';
                    break;
                case 'all':
                    buttonText += 'All';
                    break;
                default:
                    buttonText += 'Me';
            }
            
            authorFilterBtn.innerHTML = `<i class="fa fa-user me-1"></i> ${buttonText}`;
            
            // Reset to first page
            currentPage = 1;
            
            // Reload pull requests
            loadUserPullRequests();
        }
        
        // Handle sort filter change
        function handleSortFilterChange(element) {
            // Update active class
            document.querySelectorAll('#sortFilterDropdown .dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update selected sort
            selectedSort = element.getAttribute('data-sort');
            
            // Update button text
            let buttonText = 'Sort: ';
            switch (selectedSort) {
                case 'newest':
                    buttonText += 'Newest';
                    break;
                case 'oldest':
                    buttonText += 'Oldest';
                    break;
                case 'recently-updated':
                    buttonText += 'Recently updated';
                    break;
                case 'least-updated':
                    buttonText += 'Least updated';
                    break;
                case 'most-commented':
                    buttonText += 'Most commented';
                    break;
                default:
                    buttonText += 'Newest';
            }
            
            sortFilterBtn.innerHTML = `<i class="fa fa-sort me-1"></i> ${buttonText}`;
            
            // Reset to first page
            currentPage = 1;
            
            // Reload pull requests
            loadUserPullRequests();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Status filter buttons
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Update active button
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update current status
                    currentStatus = this.getAttribute('data-status');
                    
                    // Reset to first page
                    currentPage = 1;
                    
                    // Reload pull requests
                    loadUserPullRequests();
                });
            });
            
            // Search input
            searchButton.addEventListener('click', function() {
                searchQuery = searchInput.value.trim();
                currentPage = 1;
                loadUserPullRequests();
            });
            
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchQuery = this.value.trim();
                    currentPage = 1;
                    loadUserPullRequests();
                }
            });
            
            // Author filter dropdown
            document.querySelectorAll('#authorFilterDropdown .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleAuthorFilterChange(this);
                });
            });
            
            // Sort filter dropdown
            document.querySelectorAll('#sortFilterDropdown .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleSortFilterChange(this);
                });
            });
        }
        
        // Helper function: Generate hash from string
        function hashString(str) {
            let hash = 0;
            if (!str) return hash.toString(16);
            
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }
        
        // Helper function: Format time ago
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) {
                return interval + " year" + (interval === 1 ? "" : "s") + " ago";
            }
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) {
                return interval + " month" + (interval === 1 ? "" : "s") + " ago";
            }
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) {
                return interval + " day" + (interval === 1 ? "" : "s") + " ago";
            }
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) {
                return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
            }
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) {
                return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
            }
            
            return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s") + " ago";
        }
        
        // Start the application
        initialize();
    </script>
</body>
</html>